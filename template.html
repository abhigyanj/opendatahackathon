<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title data-i18n="pageTitle">Tokyo Parks Map | ÈÉΩÁ´ãÂÖ¨Âúí„Éû„ÉÉ„Éó</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f6f8fa;
      color: #222;
    }
    header {
      background: linear-gradient(90deg, #4f8ef7 0%, #1cb5e0 100%);
      color: #fff;
      padding: 32px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px #0001;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.95;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 0 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
    }
    #panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 20px 20px 20px;
      max-width: 340px;
      min-width: 260px;
      flex: 1 1 320px;
      font-size: 15px;
      margin-bottom: 32px;
      height: fit-content;
    }
    #panel strong {
      font-size: 1.2rem;
      color: #4f8ef7;
      letter-spacing: 1px;
    }
  #panel .section-label { display:flex; align-items:center; justify-content:space-between; margin-top:14px; }
  #panel .section-label h3 { margin:0; font-size:0.95rem; letter-spacing:.5px; color:#333; font-weight:600; }
  #panel small.muted { color:#667; font-size:.7rem; font-weight:500; }
  #panel button.tiny-btn { background:#eef3f8; border:1px solid #c5d3de; border-radius:6px; font-size:11px; padding:4px 10px; cursor:pointer; line-height:1; letter-spacing:.5px; display:inline-flex; align-items:center; gap:4px; }
  #panel button.tiny-btn:hover { background:#e2edf6; }
  #panel button.tiny-btn.partial { background:#fff4d3; border-color:#f0c662; }
  #panel button.tiny-btn.clear { background:#ffe3e3; border-color:#ffb2b2; }
  #panel button.tiny-btn.clear:hover { background:#ffd4d4; }
  /* Category list items */
  .cat-item { display:flex; align-items:flex-start; gap:6px; cursor:pointer; position:relative; font-size:12.5px; line-height:1.25; padding:4px 2px 4px 0; }
  .cat-item input.catChk { position:absolute; opacity:0; inset:0; cursor:pointer; }
  .cat-item .fake-box { width:18px; height:18px; border:2px solid #4f8ef7; border-radius:5px; display:flex; align-items:center; justify-content:center; background:#4f8ef7; flex:0 0 18px; box-sizing:border-box; position:relative; }
  .cat-item .fake-box .tick { font-size:13px; line-height:1; font-weight:700; color:#fff; transition:opacity .15s; }
  .cat-item.unchecked .fake-box { background:#fff; border-color:#9bb7cc; }
  .cat-item.unchecked .fake-box .tick { opacity:0; }
  .cat-item:focus-within { outline:2px solid #1cb5e0; outline-offset:2px; }
  .cat-item .color-dot { width:13px; height:13px; border-radius:50%; border:1px solid #3333; flex:0 0 13px; margin-top:2px; }
  .cat-item .cat-label { white-space:normal; word-break:keep-all; overflow-wrap:anywhere; flex:1; min-width:0; }
    #panel input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    #panel input:focus {
      border: 1.5px solid #4f8ef7;
    }
    #list {
      max-height: 50vh;
      overflow: auto;
      margin-top: 12px;
    }
    #list div {
      cursor: pointer;
      padding: 7px 0 7px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, color 0.15s;
      border-left: 4px solid transparent;
    }
    #list div:hover {
      background: #e3f0ff;
    }
    #list div.selected {
      background: #d0e7ff;
      color: #1976d2;
      border-left: 4px solid #4f8ef7;
      font-weight: 700;
    }
    .about {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 24px 20px 24px;
      margin-bottom: 32px;
      flex: 2 1 400px;
      min-width: 320px;
      max-width: 700px;
    }
    .about h2 {
      margin-top: 0;
      color: #1cb5e0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .about p {
      font-size: 1.08rem;
      line-height: 1.7;
      margin-bottom: 0.7em;
    }
    .about ul {
      margin: 0 0 0 1.2em;
      padding: 0;
      font-size: 1rem;
    }
    .about li {
      margin-bottom: 0.4em;
    }
    .map-wrap {
      width: 100%;
      height: 520px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 16px #0002;
      background: #fff;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      max-height: 520px;
    }
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 0;
      }
      .about, #panel {
        max-width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap;">
      <h1 data-i18n="headerTitle">Tokyo Parks Map | ÈÉΩÁ´ãÂÖ¨Âúí„Éû„ÉÉ„Éó</h1>
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="lang-ja" class="lang-btn" data-lang="ja" aria-pressed="true">Êó•Êú¨Ë™û</button>
        <button id="lang-en" class="lang-btn" data-lang="en" aria-pressed="false">EN</button>
      </div>
    </div>
    <p data-i18n="subtitle">Discover, search, and explore Tokyo's public parks on an interactive map.</p>
  </header>
  <div class="container">
    <div id="panel">
      <strong data-i18n="searchHeading">ÂÖ¨Âúí„ÇíÊ§úÁ¥¢</strong><br>
      <input id="q" placeholder="ÂÖ¨ÂúíÂêç„ÅßÊ§úÁ¥¢..." data-i18n-placeholder="searchPlaceholder">
      <div id="locControls" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
        <button id="locBtn" type="button" class="tiny-btn" style="display:inline-flex;align-items:center;gap:4px;">üìç <span data-i18n="useLocationLabel">ÁèæÂú®Âú∞</span></button>
        <button id="sortNameBtn" type="button" class="tiny-btn active" data-sort="name" data-i18n="sortNameLabel">A-Z</button>
        <button id="sortDistBtn" type="button" class="tiny-btn" data-sort="distance" data-i18n="sortDistanceLabel">Ë∑ùÈõ¢</button>
        <span id="locStatus" class="muted" style="flex:1; font-size:11px;"></span>
      </div>
      <!-- Distance Filter Added -->
      <div id="distanceFilter" style="display:flex;align-items:center;gap:6px;margin-top:8px;">
        <label for="distRange" style="font-size:11px;color:#555;white-space:nowrap;" data-i18n="distanceFilterLabel">Ë∑ùÈõ¢„Éï„Ç£„É´„Çø</label>
        <input id="distRange" type="range" min="0" max="20000" step="500" value="0" style="flex:1;">
        <span id="distValue" style="font-size:11px;color:#333;min-width:52px;text-align:right;" data-i18n="distanceAll">„Åô„Åπ„Å¶</span>
      </div>
      <div id="quickDistances" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
        <button class="qd-btn tiny-btn" data-dist="500">500m</button>
        <button class="qd-btn tiny-btn" data-dist="1000">1km</button>
        <button class="qd-btn tiny-btn" data-dist="2000">2km</button>
        <button class="qd-btn tiny-btn" data-dist="5000">5km</button>
        <button class="qd-btn tiny-btn" data-dist="0" data-i18n="distanceAll">„Åô„Åπ„Å¶</button>
        <button id="favToggle" class="tiny-btn" type="button" data-mode="all" style="margin-left:auto;">‚òÖ <span data-i18n="favoritesShowOnly">„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø</span></button>
      </div>
      <div class="section-label">
        <h3><span data-i18n="categoriesLabel">„Ç´„ÉÜ„Ç¥„É™„Éº</span> <small id="catCount" class="muted"></small></h3>
        <button id="catSelectAll" class="tiny-btn" type="button" aria-pressed="true" data-i18n-dynamic="selectAll">ÂÖ®Ëß£Èô§</button>
      </div>
  <div id="catBox" style="margin-top:6px; max-height:190px; overflow:auto; border:1px solid #dde5ea; border-radius:8px; padding:8px 10px 6px 10px; background:#fbfdfe; font-size:12.5px; line-height:1.35; display:grid; grid-template-columns: repeat(auto-fill,minmax(170px,1fr)); gap:4px 14px; scrollbar-width:thin;">
      </div>
      <div id="list"></div>
    </div>
    <div class="about">
      <h2 data-i18n="aboutHeading">About This Website</h2>
      <p data-i18n="aboutParagraph1">
        Tokyo Parks Map is an open-data web application that helps you discover and explore public parks across Tokyo.
      </p>
      <ul>
        <li data-i18n="bullet1">Search for parks by name in Japanese</li>
        <li data-i18n="bullet2">Click on a park to zoom to its location on the map</li>
        <li data-i18n="bullet3">View park details, addresses, and links (where available)</li>
        <li data-i18n="bullet4">Data sourced from Tokyo's open government datasets</li>
        <li data-i18n="bullet5">Built with Python, Flask, and Folium/Leaflet.js</li>
      </ul>
      <p style="margin-top:1.2em; color:#888; font-size:0.98em;" data-i18n="footer">¬© 2025 Tokyo Parks Map | Open Data Hackathon</p>
    </div>
  </div>
  <div class="map-wrap">
    <div id="map"></div>
  </div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- MarkerCluster plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    /* Icon marker styling */
    .park-icon{width:24px;height:24px;border-radius:50%;background:var(--icon-bg,#2a81cb);display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600;box-shadow:0 0 0 1px #222,0 1px 3px #0004;}
  </style>
  <script>
    // Bootstrapped data placeholder; replaced server-side.
  const {parks, centerLat, centerLon, categoryColors} = JSON.parse(decodeURIComponent('BOOTSTRAP_JSON_PLACEHOLDER'));
  const I18N = JSON.parse(decodeURIComponent('I18N_JSON_PLACEHOLDER'));
  let currentLang = (localStorage.getItem('lang')||'ja');
  let userLocation = null; // {lat, lon, accuracy}
  let locationMarker = null;
  let locationAccuracyCircle = null;
  let sortMode = 'name';
  // Added distance filter state
  let maxDistance = 0; // meters (0 = unlimited)
  let favorites = new Set(JSON.parse(localStorage.getItem('favorites')||'[]'));
  let showFavoritesOnly = false;
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const catBox = document.getElementById('catBox');
    const selectAllBtn = document.getElementById('catSelectAll');
    const categories = [...new Set(parks.map(p=>p.category).filter(Boolean))].sort();
    
    function cssSafe(s){return s.replace(/[^a-zA-Z0-9_-]/g,'_');}
    
    function buildCategoryFilters(){
      catBox.innerHTML = categories.map(cat=>{
        const safe = cat.replace(/"/g,'&quot;');
        return `<label class="cat-item" data-cat="${safe}">
          <input type="checkbox" class="catChk" value="${safe}" checked aria-label="${safe}">
          <span class="fake-box"><span class="tick">‚úì</span></span>
          <span class="color-dot" style="background:var(--cat-${cssSafe(cat)},#666);"></span>
          <span class="cat-label">${cat}</span>
        </label>`;
      }).join('');
      catBox.querySelectorAll('.catChk').forEach(cb=>{
        const label = cb.closest('.cat-item');
        if(!cb.checked) label.classList.add('unchecked');
        cb.addEventListener('change', ()=>{
          const lbl = cb.closest('.cat-item');
          if(cb.checked) lbl.classList.remove('unchecked'); else lbl.classList.add('unchecked');
          applyFilters();
        });
      });
      updateCatCount();
      updateSelectAllButton();
    }
    
    buildCategoryFilters();
    
    selectAllBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const boxes = Array.from(catBox.querySelectorAll('.catChk'));
      const allChecked = boxes.every(c=>c.checked);
      const targetState = !allChecked;
      boxes.forEach(c=>{ c.checked = targetState; const label=c.closest('.cat-item'); if(targetState) label.classList.remove('unchecked'); else label.classList.add('unchecked'); });
      applyFilters();
      updateSelectAllButton();
    });

    // Assign stable indices to handle duplicate coordinates distinctly
    parks.forEach((p,i)=>p._idx=i);
    const leafletMap = L.map('map', {zoomControl:true}).setView([centerLat, centerLon], 10);
    const baseLayers = {
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(leafletMap),
      'OSM HOT': L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors, HOT'
      }),
      'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '¬© OpenStreetMap contributors, SRTM | OpenTopoMap (CC-BY-SA)'
      }),
      'Carto Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© OpenStreetMap ¬© CARTO'
      }),
      'Carto Dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© OpenStreetMap ¬© CARTO'
      }),
      'Esri Imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles ¬© Esri & contributors'
      }),
      'Esri Topo': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles ¬© Esri & contributors'
      })
    };
    L.control.layers(baseLayers, null, {position:'topright'}).addTo(leafletMap);
    // --- Marker clustering & icon markers ---
    const clusterGroup = L.markerClusterGroup({ disableClusteringAtZoom:16, spiderfyOnMaxZoom:true, maxClusterRadius:50 });
    leafletMap.addLayer(clusterGroup);
    const markers = []; // {marker, parkIdx, cat}
    function pickIcon(category){
      if(!category) return 'üå≥';
      const lc = category.toLowerCase(); // Japanese unaffected
      // Specific Japanese / category mappings
      if(/„Åî„Åø|„Ç¥„Éü|ÂªÉÊ£Ñ|Ê∞¥ÈÅì|Áµ¶Ê∞¥/.test(lc)) return 'üöÆ';              // „Åî„Åø„ÉªÊ∞¥ÈÅìÊñΩË®≠
      if(/„Åù„ÅÆ‰ªñ/.test(lc)) return '‰ªñ';                                  // „Åù„ÅÆ‰ªñ
      if(/„Ç≥„Éü„É•„Éã„ÉÜ„Ç£|ÔΩ∫ÔæêÔΩ≠ÔæÜÔæÉÔΩ®|community/.test(lc)) return '‚õ™Ô∏è';         // „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Çª„É≥„Çø„Éº
      if(/„Çπ„Éù„Éº„ÉÑ|‰ΩìËÇ≤|sport|gym/.test(lc)) return '‚öæÔ∏è';                // „Çπ„Éù„Éº„ÉÑ„Éª‰ΩìËÇ≤È§®
      if(/‰∫§ÈÄö|ÈßÖ|station|rail|train/.test(lc)) return 'üöâ';             // ‰∫§ÈÄö„ÉªÈßÖ
      if(/‰øùËÇ≤|ÂπºÁ®öÂúí|Ë®óÂÖê|nursery|kindergarten/.test(lc)) return 'üß∏';  // ‰øùËÇ≤„ÉªÂπºÁ®öÂúí
      if(/ÂÖ¨Âúí|park/.test(lc)) return 'üõù';                              // ÂÖ¨Âúí
      if(/Âõ≥Êõ∏|„É©„Ç§„Éñ„É©„É™|library/.test(lc)) return 'üìö';                // Âõ≥Êõ∏È§®
      if(/Â≠¶Ê†°|ÊïôËÇ≤|school|college|university/.test(lc)) return 'üè´';    // Â≠¶Ê†°„ÉªÊïôËÇ≤ÊñΩË®≠
      if(/Â∏ÇÂΩπÊâÄ|ÂΩπÂ†¥|Âå∫ÂΩπÊâÄ|government|city hall/.test(lc)) return 'üèõÔ∏è'; // Â∏ÇÂΩπÊâÄ„ÉªÂΩπÂ†¥
      if(/ÊñáÂåñ|ÂçöÁâ©|museum|art|gallery/.test(lc)) return 'üñºÔ∏è';          // ÊñáÂåñ„ÉªÂçöÁâ©È§®
      if(/ÁóÖÈô¢|ÂåªÁôÇ|hospital|clinic|medical/.test(lc)) return 'üè•';      // ÁóÖÈô¢„ÉªÂåªÁôÇ
      if(/Á¶èÁ•â|welfare/.test(lc)) return 'ü§ùüèª';                           // Á¶èÁ•âÊñΩË®≠
      if(/È´òÈΩ¢|ËÄÅ‰∫∫|senior|elder/.test(lc)) return 'üëµüèª';                 // È´òÈΩ¢ËÄÖÊñΩË®≠
      return '‰ªñ';
    }
    function buildAllMarkers(){
      parks.forEach(p=>{
        const color = (categoryColors && categoryColors[p.category]) ? categoryColors[p.category] : '#2a81cb';
        const iconHtml = `<div class=\"park-icon\" style=\"--icon-bg:${color}\">${pickIcon(p.category||'')}</div>`;
        const icon = L.divIcon({className:'', html:iconHtml, iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-12]});
        const m = L.marker([p.lat, p.lon], {icon});
        let popup = `<b>${p.name}</b><br>${p.address||''}`;
        if(p.category) popup += `<br><span style=\"display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;\">${p.category}</span>`;
        if(p.url) popup += `<br><a href='${p.url}' target='_blank'>${tr('linkLabel')}</a>`;
        if(p.desc) popup += `<br><small>${p.desc.slice(0,180)}...</small>`;
        m.bindPopup(popup);
        markers.push({marker:m, parkIdx:p._idx, cat:p.category});
      });
    }
    function populateCluster(list){
      clusterGroup.clearLayers();
      const allowed = new Set(list.map(p=>p._idx));
      markers.forEach(obj=>{ if(allowed.has(obj.parkIdx)) clusterGroup.addLayer(obj.marker); });
    }
    buildAllMarkers();
    populateCluster(parks);

    function focusPark(p){
      const entry = markers.find(e=>e.parkIdx===p._idx);
      if(!entry) return;
      const marker = entry.marker;
      // Use cluster API to ensure marker is visible (expanded) before opening popup
      if(clusterGroup && typeof clusterGroup.zoomToShowLayer === 'function'){
        clusterGroup.zoomToShowLayer(marker, ()=>{
          leafletMap.flyTo(marker.getLatLng(), Math.max(leafletMap.getZoom(), 15), {animate:true, duration:0.6});
          marker.openPopup();
        });
      } else {
        leafletMap.flyTo(marker.getLatLng(), 15, {animate:true, duration:0.75});
        setTimeout(()=>marker.openPopup(), 450);
      }
     }
    function render(list){
      listEl.innerHTML = "";
      list.slice(0,300).forEach((p, idx)=>{
        const d = document.createElement('div');
        d.classList.add('park-row');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = p.name;
        d.appendChild(nameSpan);
        // Favorite star
        const star = document.createElement('button');
        star.type='button';
        star.className='fav-star';
        star.setAttribute('aria-label','favorite');
        star.textContent = favorites.has(p._idx)?'‚òÖ':'‚òÜ';
        star.style.marginLeft='8px';
        star.onclick = (e)=>{
          e.stopPropagation();
            if(favorites.has(p._idx)) favorites.delete(p._idx); else favorites.add(p._idx);
            localStorage.setItem('favorites', JSON.stringify([...favorites]));
            star.textContent = favorites.has(p._idx)?'‚òÖ':'‚òÜ';
            if(showFavoritesOnly && !favorites.has(p._idx)){
              d.remove();
            }
        };
        d.appendChild(star);
        if(typeof p.dist === 'number' && userLocation){
          const distSpan = document.createElement('span');
          distSpan.style.fontSize='11px';
          distSpan.style.marginLeft='6px';
            distSpan.style.color='#555';
          distSpan.textContent = `(${formatDistance(p.dist)})`;
          d.appendChild(distSpan);
        }
        if(p.category){
          d.style.borderLeft = `6px solid var(--cat-${cssSafe(p.category)})`;
        }
        d.tabIndex = 0;
        d.setAttribute('role', 'button');
        d.setAttribute('aria-label', p.name);
        d.onclick = ()=> {
          // Remove previous selection
          listEl.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
          d.classList.add('selected');
          // Find marker by lat/lon and open popup
          focusPark(p);
        };
        d.onkeydown = (e) => { if(e.key==="Enter"||e.key===" ") d.onclick(); };
        listEl.appendChild(d);
      });
    }

    function applyFilters(){
      const text = qEl.value.trim();
      const selected = Array.from(catBox.querySelectorAll('.catChk')).filter(c=>c.checked).map(c=>c.value);
      let filtered = parks;
      if(selected.length && selected.length !== categories.length){
        const set = new Set(selected);
        filtered = filtered.filter(p=> set.has(p.category));
      }
      if(text) filtered = filtered.filter(p=> p.name.includes(text));
      // Distance filtering (only if userLocation known and maxDistance > 0)
      if(maxDistance>0 && userLocation){
        filtered = filtered.filter(p=> typeof p.dist==='number' && p.dist <= maxDistance);
      }
      if(sortMode==='distance' && userLocation){
        filtered = [...filtered].sort((a,b)=>{
          if(typeof a.dist !== 'number') return 1;
          if(typeof b.dist !== 'number') return -1;
          return a.dist - b.dist;
        });
      } else if(sortMode==='name') {
        filtered = [...filtered].sort((a,b)=> a.name.localeCompare(b.name, 'ja'));
      }
      if(showFavoritesOnly){
        filtered = filtered.filter(p=> favorites.has(p._idx));
      }
      render(filtered);
      populateCluster(filtered);
      updateCatCount();
      updateSelectAllButton();
    }
    qEl.oninput = applyFilters;

    // Wait for map and markers to be ready
    function setupEnhancements() {
      // Add bounds & zoom constraints once
      if(!leafletMap.__customBounded){
        const bounds = [[35.4, 139.4],[35.9, 140.1]];
        leafletMap.setMaxBounds(bounds);
        leafletMap.on('drag', () => leafletMap.panInsideBounds(bounds, { animate:false }));
        leafletMap.options.minZoom = 10;
        leafletMap.options.maxZoom = 18;
        leafletMap.__customBounded = true;
      }
    }
    // Marker visibility filtering
    function updateMarkerVisibility(visibleList){
      // No-op: clustering rebuild handles visibility
     }

    // Inject dynamic CSS vars for category colors based on first matching marker icon color class
    function deriveCategoryColors(){
      // Use categoryColors directly to set CSS vars
      let css=':root{';
      Object.entries(categoryColors).forEach(([cat,color])=>{ css+=`--cat-${cssSafe(cat)}:${color};`; });
      css+='}';
      const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
      buildLegend(categoryColors);
    }
    function leafletColorToHex(c){ return c; }
    
  function buildLegend(sample){
      const legend = document.createElement('div');
      legend.style.position='absolute';
      legend.style.bottom='8px';
      legend.style.right='8px';
      legend.style.background='rgba(255,255,255,0.92)';
      legend.style.padding='8px 10px';
      legend.style.fontSize='12px';
      legend.style.border='1px solid #ccc';
      legend.style.borderRadius='6px';
      legend.style.maxHeight='220px';
      legend.style.overflow='auto';
  const legendTitle = tr('legendTitle');
  legend.innerHTML = `<b style="font-size:12px;">${legendTitle}</b><br>` +
        Object.keys(sample).sort().map(cat=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
          <span style="width:12px;height:12px;border-radius:50%;background:var(--cat-${cssSafe(cat)});"></span>
          <span>${cat}</span></div>`).join('');
      document.querySelector('.map-wrap').appendChild(legend);
    }

  function syncMarkerColors(){
    // Align marker icon background with CSS vars (in case palette changes)
    const rootStyles = getComputedStyle(document.documentElement);
    markers.forEach(obj=>{
      if(!obj.cat) return;
      const varName = `--cat-${cssSafe(obj.cat)}`;
      const col = rootStyles.getPropertyValue(varName).trim();
      if(col){
        const el = obj.marker.getElement();
        if(el){
          const div = el.querySelector('.park-icon');
          if(div) div.style.setProperty('--icon-bg', col);
        }
      }
    });
  }
  function initAfterMap(){ setupEnhancements(); deriveCategoryColors(); syncMarkerColors(); applyFilters(); }
  initAfterMap();
  render(parks);

  // Helpers for dynamic UI bits
  function updateCatCount(){
    const countEl=document.getElementById('catCount');
    if(!countEl) return;
    const total=categories.length;
    const selected=catBox.querySelectorAll('.catChk:checked').length;
    countEl.textContent = `${selected}/${total}`;
  }
  function updateSelectAllButton(){
    const btn = selectAllBtn;
    const boxes = Array.from(catBox.querySelectorAll('.catChk'));
    const selected = boxes.filter(b=>b.checked).length;
    if(selected===0){
      btn.textContent= tr('selectAll_noneSelected');
      btn.classList.remove('partial','clear');
      btn.classList.add('clear');
      btn.setAttribute('aria-pressed','false');
    } else if(selected===boxes.length){
      btn.textContent= tr('selectAll_allSelected');
      btn.classList.remove('partial','clear');
      btn.setAttribute('aria-pressed','true');
    } else {
      btn.textContent= tr('selectAll_partial');
      btn.classList.add('partial');
      btn.classList.remove('clear');
      btn.setAttribute('aria-pressed','mixed');
    }
  }

  // Translation helpers
  function tr(key){
    return (I18N[currentLang] && I18N[currentLang][key]) || key;
  }
  function applyTranslations(){
    document.documentElement.lang = currentLang;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      const txt = tr(k);
      if(txt) el.textContent = txt;
    });
    // Reset distance value label when unlimited (after translation swap)
    if(maxDistance===0){
      const dv=document.getElementById('distValue');
      if(dv) dv.textContent = tr('distanceAll');
    }
    // Update favorites toggle label
    const favSpan = document.querySelector('#favToggle span[data-i18n]');
    if(favSpan){ favSpan.textContent = tr(showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); }
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const k = el.getAttribute('data-i18n-placeholder');
      const txt = tr(k);
      if(txt) el.setAttribute('placeholder', txt);
    });
    updateSelectAllButton();
  }
  function setupLangButtons(){
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.lang===currentLang);
      btn.setAttribute('aria-pressed', btn.dataset.lang===currentLang ? 'true':'false');
      btn.onclick = ()=>{
        currentLang = btn.dataset.lang;
        localStorage.setItem('lang', currentLang);
        document.querySelectorAll('.lang-btn').forEach(b=>{
          b.classList.toggle('active', b===btn);
          b.setAttribute('aria-pressed', b===btn ? 'true':'false');
        });
        // Rebuild legend for translated title
        document.querySelectorAll('.map-wrap > div').forEach(div=>{ if(div.innerHTML && div.innerHTML.includes('var(--cat-')){ div.remove(); }});
        buildLegend(categoryColors);
        applyTranslations();
        // Rebuild popups with translated labels
        rebuildAllPopups();
      };
    });
  }
  // Style for language buttons injected dynamically
  (function(){
    const style=document.createElement('style');
    style.textContent = `.lang-btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;backdrop-filter:blur(4px);} .lang-btn.active{background:#fff;color:#1b6dcf;border-color:#fff;} .lang-btn:hover{background:#ffffff55;}`;
    document.head.appendChild(style);
  })();
  // Initial translation setup
  applyTranslations();
  setupLangButtons();

  // --- Location / Distance Features ---
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371000; // m
    const toRad = d=>d*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // meters
  }
  function updateDistances(){
    if(!userLocation) return;
    parks.forEach(p=>{
      p.dist = haversine(userLocation.lat, userLocation.lon, p.lat, p.lon);
    });
  }
  function formatDistance(m){
    const unitM = tr('distanceUnitMeters');
    const unitKm = tr('distanceUnitKilometers');
    if(m < 1000) return `${Math.round(m)} ${unitM}`;
    const km = m/1000;
    if(km < 10) return `${km.toFixed(2)} ${unitKm}`;
    return `${km.toFixed(1)} ${unitKm}`;
  }
  function requestLocation(force){
    if(userLocation && !force){
      updateDistances();
      applyFilters();
      return;
    }
    const statusEl = document.getElementById('locStatus');
    statusEl.textContent = currentLang==='ja'? '‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠...' : 'Getting location...';
    if(!navigator.geolocation){
      statusEl.textContent = currentLang==='ja'? 'Êú™ÂØæÂøú„Éñ„É©„Ç¶„Ç∂' : 'Geolocation unsupported';
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude, accuracy} = pos.coords;
      userLocation = {lat: latitude, lon: longitude, accuracy};
      statusEl.textContent = currentLang==='ja'? 'ÂèñÂæóÊ∏à' : 'Location set';
      showUserLocation();
      updateDistances();
      applyFilters();
      updatePopupsWithDirections();
    }, err=>{
      statusEl.textContent = (currentLang==='ja'? 'Â§±Êïó: ' : 'Error: ')+ err.message;
    }, {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
  }
  function showUserLocation(){
    if(!userLocation) return;
    if(locationMarker){
      locationMarker.setLatLng([userLocation.lat, userLocation.lon]);
      if(locationAccuracyCircle) locationAccuracyCircle.setLatLng([userLocation.lat, userLocation.lon]);
    } else {
      locationMarker = L.marker([userLocation.lat, userLocation.lon], {title:'You'}).addTo(leafletMap);
      locationAccuracyCircle = L.circle([userLocation.lat, userLocation.lon], {radius: userLocation.accuracy||30, color:'#136aec', fillColor:'#136aec', fillOpacity:0.15, weight:1}).addTo(leafletMap);
    }
  }
  function rebuildAllPopups(){
    markers.forEach(({marker, parkIdx})=>{
      const p = parks.find(pp=>pp._idx===parkIdx);
      if(!p) return;
      let popup = `<b>${p.name}</b><br>${p.address||''}`;
      if(p.category) popup += `<br><span style=\"display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;\">${p.category}</span>`;
      if(p.url) popup += `<br><a href='${p.url}' target='_blank'>${tr('linkLabel')}</a>`;
      if(userLocation && typeof p.dist==='number') popup += `<br><small>${formatDistance(p.dist)}</small>`;
      if(userLocation){
        const gmaps = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lon}/${p.lat},${p.lon}`;
        popup += `<br><a href='${gmaps}' target='_blank'>${tr('directionsLabel')}</a>`;
      }
      marker.bindPopup(popup);
    });
  }
  function updatePopupsWithDirections(){
    if(!userLocation) return;
    rebuildAllPopups();
  }
  document.getElementById('locBtn').addEventListener('click', ()=>{ requestLocation(); });
  document.getElementById('sortNameBtn').addEventListener('click', ()=>{ sortMode='name'; toggleSortButtons(); applyFilters(); });
  document.getElementById('sortDistBtn').addEventListener('click', ()=>{ sortMode='distance'; if(!userLocation) requestLocation(); else { updateDistances(); } toggleSortButtons(); applyFilters(); });
  // Distance range events
  const distRange = document.getElementById('distRange');
  const distValue = document.getElementById('distValue');
  if(distRange){
    distRange.addEventListener('input', ()=>{
      const v = parseInt(distRange.value,10);
      maxDistance = v;
      if(v===0){
        distValue.textContent = tr('distanceAll');
      } else if(v < 1000){
        distValue.textContent = v + ' ' + tr('distanceUnitMeters');
      } else {
        distValue.textContent = (v/1000).toFixed(v%1000===0?0:1) + ' ' + tr('distanceUnitKilometers');
      }
      if(!userLocation && v>0){ requestLocation(); } else { applyFilters(); }
    });
  }
  // Quick distance chips
  document.querySelectorAll('.qd-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const dist = parseInt(btn.dataset.dist,10);
      maxDistance = dist;
      if(distRange) distRange.value = dist;
      if(dist===0){ distValue.textContent = tr('distanceAll'); }
      else if(dist<1000){ distValue.textContent = dist + ' ' + tr('distanceUnitMeters'); }
      else distValue.textContent = (dist/1000).toFixed(dist%1000===0?0:1) + ' ' + tr('distanceUnitKilometers');
      if(dist>0 && !userLocation) requestLocation(); else applyFilters();
      document.querySelectorAll('.qd-btn').forEach(b=> b.classList.toggle('active', b===btn));
    });
  });
  // Favorites toggle
  const favToggle = document.getElementById('favToggle');
  favToggle.addEventListener('click', ()=>{
    showFavoritesOnly = !showFavoritesOnly;
    favToggle.dataset.mode = showFavoritesOnly? 'fav':'all';
    const span = favToggle.querySelector('span[data-i18n]');
    if(span){ span.setAttribute('data-i18n', showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); span.textContent = tr(showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); }
    applyFilters();
  });
  // Optional: try auto locate after short delay (can be removed if undesired)
  setTimeout(()=>{ /* requestLocation(); */ }, 2500);

  // Enhance styles for active sort
  (function(){
    const style=document.createElement('style');
    style.textContent += `.tiny-btn.active{background:#1cb5e0 !important; color:#fff !important; border-color:#1699bd !important;}`;
    style.textContent += `.qd-btn.active{background:#1cb5e0;color:#fff;border-color:#1699bd;}`;
    style.textContent += `.fav-star{background:transparent;border:none;cursor:pointer;font-size:14px;line-height:1;padding:0 2px;color:#e0b800;} .fav-star:hover{transform:scale(1.15);} .fav-star:focus{outline:2px solid #1cb5e0;outline-offset:2px;}`;
    document.head.appendChild(style);
  })();

  </script>
</body>
</html>
