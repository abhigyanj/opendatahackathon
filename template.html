<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Tokyo Parks Map | 都立公園マップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f6f8fa;
      color: #222;
    }
    header {
      background: linear-gradient(90deg, #4f8ef7 0%, #1cb5e0 100%);
      color: #fff;
      padding: 32px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px #0001;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.95;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 0 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
    }
    #panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 20px 20px 20px;
      max-width: 340px;
      min-width: 260px;
      flex: 1 1 320px;
      font-size: 15px;
      margin-bottom: 32px;
      height: fit-content;
    }
    #panel strong {
      font-size: 1.2rem;
      color: #4f8ef7;
      letter-spacing: 1px;
    }
    #panel input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    #panel input:focus {
      border: 1.5px solid #4f8ef7;
    }
    #list {
      max-height: 50vh;
      overflow: auto;
      margin-top: 12px;
    }
    #list div {
      cursor: pointer;
      padding: 7px 0 7px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, color 0.15s;
      border-left: 4px solid transparent;
    }
    #list div:hover {
      background: #e3f0ff;
    }
    #list div.selected {
      background: #d0e7ff;
      color: #1976d2;
      border-left: 4px solid #4f8ef7;
      font-weight: 700;
    }
    .about {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 24px 20px 24px;
      margin-bottom: 32px;
      flex: 2 1 400px;
      min-width: 320px;
      max-width: 700px;
    }
    .about h2 {
      margin-top: 0;
      color: #1cb5e0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .about p {
      font-size: 1.08rem;
      line-height: 1.7;
      margin-bottom: 0.7em;
    }
    .about ul {
      margin: 0 0 0 1.2em;
      padding: 0;
      font-size: 1rem;
    }
    .about li {
      margin-bottom: 0.4em;
    }
    .map-wrap {
      width: 100%;
      height: 520px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 16px #0002;
      background: #fff;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      max-height: 520px;
    }
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 0;
      }
      .about, #panel {
        max-width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tokyo Parks Map <span style="font-size:1.2rem;">| 都立公園マップ</span></h1>
    <p>Discover, search, and explore Tokyo's public parks on an interactive map.</p>
  </header>
  <div class="container">
    <div id="panel">
      <strong>公園を検索</strong><br>
      <input id="q" placeholder="公園名で検索...">
      <div style="margin-top:12px; font-size:0.9rem; color:#555; display:flex;align-items:center;justify-content:space-between;">
        <span>カテゴリー</span>
        <button id="catSelectAll" style="background:#eef3f8;border:1px solid #c5d3de;border-radius:4px;font-size:10px;padding:2px 6px;cursor:pointer;">全選択</button>
      </div>
      <div id="catBox" style="margin-top:6px; max-height:180px; overflow:auto; border:1px solid #e0e6ea; border-radius:6px; padding:6px 8px; background:#fafcfd; font-size:12px; line-height:1.35; display:grid; grid-template-columns: 1fr 1fr; gap:2px 8px;"></div>
      <div id="list"></div>
    </div>
    <div class="about">
      <h2>About This Website</h2>
      <p>
        <b>Tokyo Parks Map</b> is an open-data web application that helps you discover and explore public parks across Tokyo. The interactive map allows you to search for parks by name, view their locations, and access details such as addresses and descriptions. This project is built for the Open Data Hackathon to promote the use of public data for the benefit of residents and visitors.
      </p>
      <ul>
        <li>Search for parks by name in Japanese</li>
        <li>Click on a park to zoom to its location on the map</li>
        <li>View park details, addresses, and links (where available)</li>
        <li>Data sourced from Tokyo's open government datasets</li>
        <li>Built with Python, Flask, and Folium/Leaflet.js</li>
      </ul>
      <p style="margin-top:1.2em; color:#888; font-size:0.98em;">&copy; 2025 Tokyo Parks Map | Open Data Hackathon</p>
    </div>
  </div>
  <div class="map-wrap">
    <div id="map"></div>
  </div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Bootstrapped data placeholder; replaced server-side.
    const {parks, centerLat, centerLon, categoryColors} = JSON.parse(decodeURIComponent('BOOTSTRAP_JSON_PLACEHOLDER'));
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const catBox = document.getElementById('catBox');
    const selectAllBtn = document.getElementById('catSelectAll');
    const categories = [...new Set(parks.map(p=>p.category).filter(Boolean))].sort();
    
    function cssSafe(s){return s.replace(/[^a-zA-Z0-9_-]/g,'_');}
    
    function buildCategoryFilters(){
      catBox.innerHTML = categories.map(cat=>`<label style="display:flex;align-items:center;gap:4px;margin:0;cursor:pointer;white-space:nowrap;">
        <input type="checkbox" class="catChk" value="${cat.replace(/"/g,'&quot;')}" checked style="margin:0;">
        <span style="display:inline-flex;align-items:center;gap:4px;">
          <span style="width:10px;height:10px;border-radius:50%;background:var(--cat-${cssSafe(cat)},#888);border:1px solid #999;"></span>
          <span>${cat}</span>
        </span>
      </label>`).join('');
      catBox.querySelectorAll('.catChk').forEach(cb=>cb.addEventListener('change', applyFilters));
    }
    
    buildCategoryFilters();
    
    selectAllBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const all = Array.from(catBox.querySelectorAll('.catChk'));
      const allChecked = all.every(c=>c.checked);
      all.forEach(c=>c.checked = !allChecked);
      selectAllBtn.textContent = allChecked ? '全選択' : '全解除';
      applyFilters();
    });

    // Initialize Leaflet map
    const leafletMap = L.map('map', {zoomControl:true}).setView([centerLat, centerLon], 10);
    // Base layers
    const baseLayers = {
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'© OpenStreetMap contributors'}).addTo(leafletMap),
      'Carto Light': L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap © CARTO', maxZoom:20}),
      'Carto Dark': L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap © CARTO', maxZoom:20}),
    };
    L.control.layers(baseLayers, null, {position:'topright'}).addTo(leafletMap);
    // Create markers layer group for easier management
    const markerGroup = L.layerGroup().addTo(leafletMap);
    const markerIndex = {};
    function addMarkers() {
      parks.forEach(p=>{
        const color = (categoryColors && categoryColors[p.category]) ? categoryColors[p.category] : 'blue';
        const marker = L.circleMarker([p.lat, p.lon], {
          radius:6,
            color: '#222',
            weight:1,
            fillColor: color,
            fillOpacity:0.85
        }).addTo(markerGroup);
        let popup = `<b>${p.name}</b><br>${p.address||''}`;
        if(p.category) popup += `<br><span style="display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;">${p.category}</span>`;
        if(p.url) popup += `<br><a href='${p.url}' target='_blank'>Link</a>`;
        if(p.desc) popup += `<br><small>${p.desc.slice(0,180)}...</small>`;
        marker.bindPopup(popup);
        const key = `${p.lat.toFixed(6)},${p.lon.toFixed(6)}`;
        markerIndex[key] = marker;
      });
    }
    addMarkers();

    function focusPark(p){
  leafletMap.flyTo([p.lat, p.lon], 15, {animate:true, duration:0.75});
  const key = `${p.lat.toFixed(6)},${p.lon.toFixed(6)}`;
  const marker = markerIndex[key];
  if(marker) setTimeout(()=>marker.openPopup(), 450);
    }
    function render(list){
      listEl.innerHTML = "";
      list.slice(0,300).forEach((p, idx)=>{
        const d = document.createElement('div');
        d.textContent = p.name;
        if(p.category){
          d.style.borderLeft = `6px solid var(--cat-${cssSafe(p.category)})`;
        }
        d.tabIndex = 0;
        d.setAttribute('role', 'button');
        d.setAttribute('aria-label', p.name);
        d.onclick = ()=> {
          // Remove previous selection
          listEl.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
          d.classList.add('selected');
          // Find marker by lat/lon and open popup
          focusPark(p);
        };
        d.onkeydown = (e) => { if(e.key==="Enter"||e.key===" ") d.onclick(); };
        listEl.appendChild(d);
      });
    }

    function applyFilters(){
      const text = qEl.value.trim();
      const selected = Array.from(catBox.querySelectorAll('.catChk')).filter(c=>c.checked).map(c=>c.value);
      let filtered = parks;
      if(selected.length && selected.length !== categories.length){
        const set = new Set(selected);
        filtered = filtered.filter(p=> set.has(p.category));
      }
      if(text) filtered = filtered.filter(p=> p.name.includes(text));
      render(filtered);
      updateMarkerVisibility(filtered);
    }
    qEl.oninput = applyFilters;

    // Wait for map and markers to be ready
    function setupEnhancements() {
      // Add bounds & zoom constraints once
      if(!leafletMap.__customBounded){
        const bounds = [[35.4, 139.4],[35.9, 140.1]];
        leafletMap.setMaxBounds(bounds);
        leafletMap.on('drag', () => leafletMap.panInsideBounds(bounds, { animate:false }));
        leafletMap.options.minZoom = 10;
        leafletMap.options.maxZoom = 18;
        leafletMap.__customBounded = true;
      }
    }
    // Marker visibility filtering
    function updateMarkerVisibility(visibleList){
      const allowed = new Set(visibleList.map(p=>`${p.lat.toFixed(6)},${p.lon.toFixed(6)}`));
  Object.entries(markerIndex).forEach(([k,m])=>{ m.getElement().style.display = allowed.has(k)?'':'none'; });
    }

    // Inject dynamic CSS vars for category colors based on first matching marker icon color class
    function deriveCategoryColors(){
      // Use categoryColors directly to set CSS vars
      let css=':root{';
      Object.entries(categoryColors).forEach(([cat,color])=>{ css+=`--cat-${cssSafe(cat)}:${color};`; });
      css+='}';
      const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
      buildLegend(categoryColors);
    }
    function leafletColorToHex(c){ return c; }
    
    function buildLegend(sample){
      const legend = document.createElement('div');
      legend.style.position='absolute';
      legend.style.bottom='8px';
      legend.style.right='8px';
      legend.style.background='rgba(255,255,255,0.92)';
      legend.style.padding='8px 10px';
      legend.style.fontSize='12px';
      legend.style.border='1px solid #ccc';
      legend.style.borderRadius='6px';
      legend.style.maxHeight='220px';
      legend.style.overflow='auto';
      legend.innerHTML = '<b style="font-size:12px;">カテゴリー</b><br>' +
        Object.keys(sample).sort().map(cat=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
          <span style="width:12px;height:12px;border-radius:50%;background:var(--cat-${cssSafe(cat)});"></span>
          <span>${cat}</span></div>`).join('');
      document.querySelector('.map-wrap').appendChild(legend);
    }

  function initAfterMap(){ setupEnhancements(); deriveCategoryColors(); applyFilters(); }
  initAfterMap();
  render(parks);

  </script>
</body>
</html>
