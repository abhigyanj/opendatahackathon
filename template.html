<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title data-i18n="pageTitle">Êù±‰∫¨ÂÖ¨ÂÖ±ÊñΩË®≠„Éû„ÉÉ„Éó</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    body { margin:0; font-family:'Roboto',Arial,sans-serif; background: radial-gradient(circle at 25% 20%, #f0f6ff 0%, #e8f1fa 32%, #e2edf7 55%, #dde7f1 70%, #d8e2ec 85%, #d4dee8 100%); color:#222; }
    header { background: linear-gradient(120deg,#4f8ef7 0%,#3ca9f2 40%,#1cb5e0 100%); color:#fff; padding:28px 0 14px 0; text-align:center; box-shadow:0 4px 22px -8px #0d294533,0 2px 8px #0d29451f; position:sticky; top:0; z-index:30; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    header h1 { margin:0 0 8px 0; font-size:2.5rem; font-weight:700; letter-spacing:1px; }
    header p { margin:0; font-size:1.1rem; font-weight:400; opacity:0.95; }
    .main-wrap { display:flex; gap:28px; max-width:1400px; margin:24px auto 40px auto; padding:0 22px; align-items:stretch; }
    .map-col { flex:1 1 auto; display:flex; flex-direction:column; gap:22px; min-width:0; }
    @media (max-width:1050px){ .main-wrap{ gap:22px; padding:0 18px; } }
    @media (max-width:900px){ .main-wrap{ flex-direction:column; } .map-col{ order:2; } #panel{ position:static; max-height:none; } }
    #panel { background:rgba(255,255,255,0.68); border:1px solid rgba(255,255,255,0.55); border-radius:22px; box-shadow:0 10px 32px -12px #0f2a462e,0 4px 12px -4px #0f2a4622,0 0 0 1px #ffffff55 inset; padding:22px 22px 26px 22px; font-size:15px; position:sticky; top:14px; max-height:calc(100vh - 28px); overflow:auto; scrollbar-width:thin; backdrop-filter:blur(18px) saturate(140%); -webkit-backdrop-filter:blur(18px) saturate(140%); }
    #panel strong { font-size:1.2rem; color:#4f8ef7; letter-spacing:1px; }
    #panel .section-label { display:flex; align-items:center; justify-content:space-between; margin-top:14px; }
    #panel .section-label h3 { margin:0; font-size:0.95rem; letter-spacing:.5px; color:#333; font-weight:600; }
    #panel small.muted { color:#667; font-size:.7rem; font-weight:500; }
    #panel button.tiny-btn { background:#eef3f8; border:1px solid #c5d3de; border-radius:6px; font-size:11px; padding:4px 10px; cursor:pointer; line-height:1; letter-spacing:.5px; display:inline-flex; align-items:center; gap:4px; }
    #panel button.tiny-btn:hover { background:#e2edf6; }
    #panel button.tiny-btn.partial { background:#fff4d3; border-color:#f0c662; }
    #panel button.tiny-btn.clear { background:#ffe3e3; border-color:#ffb2b2; }
    #panel button.tiny-btn.clear:hover { background:#ffd4d4; }
  #quickDistances .tiny-btn, #quickDistances .qd-btn { flex:0 0 auto; white-space:nowrap; }
    .cat-item { display:flex; align-items:flex-start; gap:6px; cursor:pointer; position:relative; font-size:12.5px; line-height:1.25; padding:4px 2px 4px 0; }
    .cat-item input.catChk { position:absolute; opacity:0; inset:0; cursor:pointer; }
    .cat-item .fake-box { width:18px; height:18px; border:2px solid #4f8ef7; border-radius:5px; display:flex; align-items:center; justify-content:center; background:#4f8ef7; flex:0 0 18px; box-sizing:border-box; position:relative; }
    .cat-item .fake-box .tick { font-size:13px; line-height:1; font-weight:700; color:#fff; transition:opacity .15s; }
    .cat-item.unchecked .fake-box { background:#fff; border-color:#9bb7cc; }
    .cat-item.unchecked .fake-box .tick { opacity:0; }
    .cat-item:focus-within { outline:2px solid #1cb5e0; outline-offset:2px; }
    .cat-item .color-dot { width:13px; height:13px; border-radius:50%; border:1px solid #3333; flex:0 0 13px; margin-top:2px; }
    .cat-item .cat-label { white-space:normal; word-break:keep-all; overflow-wrap:anywhere; flex:1; min-width:0; }
    #panel input { width:100%; box-sizing:border-box; padding:8px 10px; margin-top:10px; border:1px solid #cfd8dc; border-radius:6px; font-size:1rem; outline:none; transition:border 0.2s; }
    #panel input:focus { border:1.5px solid #4f8ef7; }
    #list { margin-top:12px; }
    #list div { cursor:pointer; padding:8px 10px 8px 10px; margin:0 0 6px 0; border:1px solid #e4ebf0; background:#fff; border-radius:10px; transition: box-shadow .18s, transform .18s, background .18s; display:flex; align-items:center; flex-wrap:wrap; }
    #list div:hover { box-shadow:0 3px 10px -3px #1a2a401a; transform:translateY(-2px); }
    #list div.selected { background:#eef6ff; border-color:#b3d9ff; box-shadow:0 0 0 2px #e0f1ff inset; }
    .about { background:rgba(255,255,255,0.55); border:1px solid rgba(255,255,255,0.5); border-radius:22px; box-shadow:0 6px 28px -10px #0f2a4630,0 2px 10px -4px #0f2a461e,0 0 0 1px #ffffff40 inset; padding:26px 30px 24px 30px; backdrop-filter:blur(16px) saturate(160%); -webkit-backdrop-filter:blur(16px) saturate(160%); position:relative; }
    .about.collapsed{padding:14px 30px 8px 30px;}
    .about-toggle{position:absolute; top:12px; right:16px; background:rgba(255,255,255,0.6); border:1px solid #ffffffaa; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border-radius:40px; font-size:11px; padding:4px 10px; cursor:pointer; font-weight:600; letter-spacing:.5px; color:#256;}
    .about-toggle:hover{background:#fff;}
    .about h2 { margin-top:0; color:#1cb5e0; font-size:1.5rem; font-weight:700; }
    .about p { font-size:1.08rem; line-height:1.7; margin-bottom:0.7em; }
    .about ul { margin:0 0 0 1.2em; padding:0; font-size:1rem; }
    .about li { margin-bottom:0.4em; }
    .map-wrap { width:100%; height:60vh; min-height:400px; border-radius:26px; overflow:hidden; box-shadow:0 12px 42px -18px #0f2a4642,0 5px 18px -6px #0f2a462a,0 0 0 1px #ffffff55 inset; background:rgba(255,255,255,0.55); position:relative; backdrop-filter:blur(14px) saturate(160%); -webkit-backdrop-filter:blur(14px) saturate(160%); }
    @media (min-height:900px){ .map-wrap{height:66vh;} }
    @media (max-width:900px){ .map-wrap{height:55vh; min-height:360px;} }
    @media (max-height:750px){ .map-wrap{height:52vh; min-height:340px;} #panel{max-height:calc(100vh - 20px);} }
    @media (max-height:680px){ .map-wrap{height:50vh;} }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap;">
  <h1 data-i18n="headerTitle">Êù±‰∫¨ÂÖ¨ÂÖ±ÊñΩË®≠„Éû„ÉÉ„Éó</h1>
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="lang-ja" class="lang-btn" data-lang="ja" aria-pressed="true">Êó•Êú¨Ë™û</button>
        <button id="lang-en" class="lang-btn" data-lang="en" aria-pressed="false">EN</button>
  <button id="lang-ko" class="lang-btn" data-lang="ko" aria-pressed="false">ÌïúÍµ≠Ïñ¥</button>
  <button id="lang-zh" class="lang-btn" data-lang="zh" aria-pressed="false">‰∏≠Êñá</button>
      </div>
    </div>
    <p data-i18n="subtitle">Discover, search, and explore Tokyo's public parks on an interactive map.</p>
  </header>
  <div class="main-wrap">
    <div id="panel">
      <div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">
        <strong data-i18n="searchHeading">ÂÖ¨Âúí„ÇíÊ§úÁ¥¢</strong>
        <span id="resultCount" style="font-size:12px;color:#555;"></span>
      </div><br>
      <input id="q" placeholder="ÂÖ¨ÂúíÂêç„ÅßÊ§úÁ¥¢..." data-i18n-placeholder="searchPlaceholder">
      <div id="locControls" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
        <button id="locBtn" type="button" class="tiny-btn" style="display:inline-flex;align-items:center;gap:4px;">üìç <span data-i18n="useLocationLabel">ÁèæÂú®Âú∞</span></button>
        <button id="sortNameBtn" type="button" class="tiny-btn active" data-sort="name" data-i18n="sortNameLabel">A-Z</button>
        <button id="sortDistBtn" type="button" class="tiny-btn" data-sort="distance" data-i18n="sortDistanceLabel">Ë∑ùÈõ¢</button>
        <span id="locStatus" class="muted" style="flex:1; font-size:11px;"></span>
      </div>
      <!-- Distance Filter Added -->
      <div id="distanceFilter" style="display:flex;align-items:center;gap:6px;margin-top:8px;">
        <label for="distRange" style="font-size:11px;color:#555;white-space:nowrap;" data-i18n="distanceFilterLabel">Ë∑ùÈõ¢„Éï„Ç£„É´„Çø</label>
        <input id="distRange" type="range" min="0" max="20000" step="500" value="0" style="flex:1;">
        <span id="distValue" style="font-size:11px;color:#333;min-width:52px;text-align:right;" data-i18n="distanceAll">„Åô„Åπ„Å¶</span>
      </div>
  <div id="quickDistances" style="display:flex;flex-wrap:nowrap;gap:6px;margin-top:6px;overflow-x:auto;padding-bottom:2px;scrollbar-width:thin;">
        <button class="qd-btn tiny-btn" data-dist="500">500m</button>
        <button class="qd-btn tiny-btn" data-dist="1000">1km</button>
        <button class="qd-btn tiny-btn" data-dist="2000">2km</button>
        <button class="qd-btn tiny-btn" data-dist="5000">5km</button>
        <button class="qd-btn tiny-btn" data-dist="0" data-i18n="distanceAll">„Åô„Åπ„Å¶</button>
        <button id="favToggle" class="tiny-btn" type="button" data-mode="all" style="margin-left:auto;">‚òÖ <span data-i18n="favoritesShowOnly">„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø</span></button>
      </div>
      <div class="section-label">
        <h3><span data-i18n="categoriesLabel">„Ç´„ÉÜ„Ç¥„É™„Éº</span> <small id="catCount" class="muted"></small></h3>
        <button id="catSelectAll" class="tiny-btn" type="button" aria-pressed="true" data-i18n-dynamic="selectAll">ÂÖ®Ëß£Èô§</button>
      </div>
  <div id="catBox" style="margin-top:6px; max-height:190px; overflow:auto; border:1px solid #dde5ea; border-radius:8px; padding:8px 10px 6px 10px; background:#fbfdfe; font-size:12.5px; line-height:1.35; display:grid; grid-template-columns: repeat(auto-fill,minmax(170px,1fr)); gap:4px 14px; scrollbar-width:thin;">
      </div>
      <div id="list"></div>
    </div>
    <div class="map-col">
      <div class="map-wrap"><div id="map"></div></div>
      <div class="about" id="aboutBox">
        <button type="button" class="about-toggle" id="aboutToggle">‚àí</button>
      <h2 data-i18n="aboutHeading">About This Website</h2>
      <p data-i18n="aboutParagraph1">
        Tokyo Public Facilities Map is an open-data web application that helps you discover and explore public parks across Tokyo.
      </p>
      <ul>
        <li data-i18n="bullet1">Search for public facilities by name in Japanese</li>
        <li data-i18n="bullet2">Click on a public facilities to zoom to its location on the map</li>
        <li data-i18n="bullet3">View park details, addresses, and links (where available)</li>
        <li data-i18n="bullet4">Data sourced from Tokyo's open government datasets</li>
        <li data-i18n="bullet5">Built with Python, Flask, and Folium/Leaflet.js</li>
      </ul>
      <p style="margin-top:1.2em; color:#888; font-size:0.98em;" data-i18n="footer">¬© 2025 Tokyo Parks Map | Open Data Hackathon</p>
  </div>
    </div>
  </div>
  <footer style="max-width:1400px;margin:-12px auto 50px auto;padding:0 28px;font-size:12px;color:#667;">
    <span data-i18n="footer">¬© 2025 Tokyo Public Facilities Map | „Ç™„Éº„Éó„É≥„Éá„Éº„Çø„Éè„ÉÉ„Ç´„ÇΩ„É≥</span>
  </footer>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Fuzzy search library -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <!-- MarkerCluster plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    /* Icon marker styling */
    .park-icon{width:24px;height:24px;border-radius:50%;background:var(--icon-bg,#2a81cb);display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600;box-shadow:0 0 0 1px #222,0 1px 3px #0004;}
  </style>
  <script>
    // About collapse control
    document.addEventListener('DOMContentLoaded',()=>{
      const toggle = document.getElementById('aboutToggle');
      const box = document.getElementById('aboutBox');
      if(toggle && box){
        toggle.addEventListener('click',()=>{
          const collapsed = box.classList.toggle('collapsed');
          toggle.textContent = collapsed ? '+' : '‚àí';
          const list = box.querySelector('ul');
          const para = box.querySelector('p');
          if(collapsed){
            if(list) list.style.display='none';
            if(para) para.style.display='none';
          } else {
            if(list) list.style.display='';
            if(para) para.style.display='';
          }
        });
      }
    });
    // Bootstrapped data placeholder; replaced server-side.
  const {publicFacilities, centerLat, centerLon, categoryColors} = JSON.parse(decodeURIComponent('BOOTSTRAP_JSON_PLACEHOLDER'));
  const I18N = JSON.parse(decodeURIComponent('I18N_JSON_PLACEHOLDER'));
  let currentLang = (localStorage.getItem('lang')||'ja');
  let userLocation = null; // {lat, lon, accuracy}
  let locationMarker = null;
  let locationAccuracyCircle = null;
  let sortMode = 'name';
  // Ensure sort button states reflect current mode
  function toggleSortButtons(){
    const nameBtn = document.getElementById('sortNameBtn');
    const distBtn = document.getElementById('sortDistBtn');
    if(nameBtn) nameBtn.classList.toggle('active', sortMode==='name');
    if(distBtn) distBtn.classList.toggle('active', sortMode==='distance');
  }
  // Added distance filter state
  let maxDistance = 0; // meters (0 = unlimited)
  let favorites = new Set(JSON.parse(localStorage.getItem('favorites')||'[]'));
  let showFavoritesOnly = false;
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const catBox = document.getElementById('catBox');
    const selectAllBtn = document.getElementById('catSelectAll');
  const categories = [...new Set(publicFacilities.map(p=>p.category).filter(Boolean))].sort();
    
    // Create a stable, UNIQUE, CSS-safe token per category (Japanese chars were collapsing to underscores)
    function cssSafe(s){
      return 'c' + Array.from(s).map(ch=>ch.charCodeAt(0).toString(16)).join('-');
    }
    
    function buildCategoryFilters(){
      catBox.innerHTML = categories.map(cat=>{
        const safe = cat.replace(/"/g,'&quot;');
        return `<label class="cat-item" data-cat="${safe}">
          <input type="checkbox" class="catChk" value="${safe}" checked aria-label="${safe}">
          <span class="fake-box"><span class="tick">‚úì</span></span>
          <span class="color-dot" style="background:var(--cat-${cssSafe(cat)},#666);"></span>
          <span class="cat-label">${cat}</span>
        </label>`;
      }).join('');
      catBox.querySelectorAll('.catChk').forEach(cb=>{
        const label = cb.closest('.cat-item');
        if(!cb.checked) label.classList.add('unchecked');
        cb.addEventListener('change', ()=>{
          const lbl = cb.closest('.cat-item');
          if(cb.checked) lbl.classList.remove('unchecked'); else lbl.classList.add('unchecked');
          applyFilters();
        });
      });
      updateCatCount();
      updateSelectAllButton();
    }
    
    buildCategoryFilters();
    
    selectAllBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const boxes = Array.from(catBox.querySelectorAll('.catChk'));
      const allChecked = boxes.every(c=>c.checked);
      const targetState = !allChecked;
      boxes.forEach(c=>{ c.checked = targetState; const label=c.closest('.cat-item'); if(targetState) label.classList.remove('unchecked'); else label.classList.add('unchecked'); });
      applyFilters();
      updateSelectAllButton();
    });

    // Assign stable indices to handle duplicate coordinates distinctly
  publicFacilities.forEach((p,i)=>p._idx=i);
    const leafletMap = L.map('map', {zoomControl:true}).setView([centerLat, centerLon], 10);
    const baseLayers = {
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(leafletMap),
      'OSM HOT': L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors, HOT'
      }),
      'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '¬© OpenStreetMap contributors, SRTM | OpenTopoMap (CC-BY-SA)'
      }),
      'Carto Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© OpenStreetMap ¬© CARTO'
      }),
      'Carto Dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© OpenStreetMap ¬© CARTO'
      }),
      'Esri Imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles ¬© Esri & contributors'
      }),
      'Esri Topo': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles ¬© Esri & contributors'
      })
    };
    L.control.layers(baseLayers, null, {position:'topright'}).addTo(leafletMap);
    // --- Marker clustering & icon markers ---
    const clusterGroup = L.markerClusterGroup({ disableClusteringAtZoom:16, spiderfyOnMaxZoom:true, maxClusterRadius:50 });
    leafletMap.addLayer(clusterGroup);
    const markers = []; // {marker, parkIdx, cat}
    function pickIcon(category){
      if(!category) return '‰ªñ';
      const lc = category.toLowerCase(); // Japanese unaffected
      // Specific Japanese / category mappings
      if(/„Åî„Åø|„Ç¥„Éü|ÂªÉÊ£Ñ|Ê∞¥ÈÅì|Áµ¶Ê∞¥/.test(lc)) return 'üöÆ';              // „Åî„Åø„ÉªÊ∞¥ÈÅìÊñΩË®≠
      if(/„Åù„ÅÆ‰ªñ/.test(lc)) return '‰ªñ';                                  // „Åù„ÅÆ‰ªñ
      if(/„Ç≥„Éü„É•„Éã„ÉÜ„Ç£|ÔΩ∫ÔæêÔΩ≠ÔæÜÔæÉÔΩ®|community/.test(lc)) return '‚õ™Ô∏è';         // „Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Çª„É≥„Çø„Éº
      if(/„Çπ„Éù„Éº„ÉÑ|‰ΩìËÇ≤|sport|gym/.test(lc)) return '‚öæÔ∏è';                // „Çπ„Éù„Éº„ÉÑ„Éª‰ΩìËÇ≤È§®
      if(/‰∫§ÈÄö|ÈßÖ|station|rail|train/.test(lc)) return 'üöó';             // ‰∫§ÈÄö„ÉªÈßÖ
      if(/‰øùËÇ≤|ÂπºÁ®öÂúí|Ë®óÂÖê|nursery|kindergarten/.test(lc)) return 'üß∏';  // ‰øùËÇ≤„ÉªÂπºÁ®öÂúí
      if(/ÂÖ¨Âúí|park/.test(lc)) return 'üå≥';                              // ÂÖ¨Âúí
      if(/Âõ≥Êõ∏|„É©„Ç§„Éñ„É©„É™|library/.test(lc)) return 'üìö';                // Âõ≥Êõ∏È§®
      if(/Â≠¶Ê†°|ÊïôËÇ≤|school|college|university/.test(lc)) return 'üè´';    // Â≠¶Ê†°„ÉªÊïôËÇ≤ÊñΩË®≠
      if(/Â∏ÇÂΩπÊâÄ|ÂΩπÂ†¥|Âå∫ÂΩπÊâÄ|government|city hall/.test(lc)) return 'üèõÔ∏è'; // Â∏ÇÂΩπÊâÄ„ÉªÂΩπÂ†¥
      if(/ÊñáÂåñ|ÂçöÁâ©|museum|art|gallery/.test(lc)) return 'üñºÔ∏è';          // ÊñáÂåñ„ÉªÂçöÁâ©È§®
      if(/ÁóÖÈô¢|ÂåªÁôÇ|hospital|clinic|medical/.test(lc)) return 'üè•';      // ÁóÖÈô¢„ÉªÂåªÁôÇ
      if(/Á¶èÁ•â|welfare/.test(lc)) return 'ü§ùüèª';                           // Á¶èÁ•âÊñΩË®≠
      if(/È´òÈΩ¢|ËÄÅ‰∫∫|senior|elder/.test(lc)) return 'üëµüèª';                 // È´òÈΩ¢ËÄÖÊñΩË®≠
    if (/‰ΩèÂå∫ÊñΩË®≠/.test(lc)) return 'üè†';               
      return '‰ªñ';
    }
    function buildAllMarkers(){
      publicFacilities.forEach(p=>{
        const color = (categoryColors && categoryColors[p.category]) ? categoryColors[p.category] : '#2a81cb';
        const iconHtml = `<div class=\"park-icon\" style=\"--icon-bg:${color}\">${pickIcon(p.category||'')}</div>`;
        const icon = L.divIcon({className:'', html:iconHtml, iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-12]});
        const m = L.marker([p.lat, p.lon], {icon});
        let popup = `<b>${p.name}</b><br>${p.address||''}`;
        if(p.category) popup += `<br><span style=\"display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;\">${p.category}</span>`;
        if(p.url) popup += `<br><a href='${p.url}' target='_blank'>${tr('linkLabel')}</a>`;
        m.bindPopup(popup);
        markers.push({marker:m, parkIdx:p._idx, cat:p.category});
      });
    }
  function populateCluster(list){
      clusterGroup.clearLayers();
      const allowed = new Set(list.map(p=>p._idx));
      markers.forEach(obj=>{ if(allowed.has(obj.parkIdx)) clusterGroup.addLayer(obj.marker); });
    }
    buildAllMarkers();
  populateCluster(publicFacilities);

    function focusPark(p){
      const entry = markers.find(e=>e.parkIdx===p._idx);
      if(!entry) return;
      const marker = entry.marker;
      // Use cluster API to ensure marker is visible (expanded) before opening popup
      if(clusterGroup && typeof clusterGroup.zoomToShowLayer === 'function'){
        clusterGroup.zoomToShowLayer(marker, ()=>{
          leafletMap.flyTo(marker.getLatLng(), Math.max(leafletMap.getZoom(), 15), {animate:true, duration:0.6});
          marker.openPopup();
        });
      } else {
        leafletMap.flyTo(marker.getLatLng(), 15, {animate:true, duration:0.75});
        setTimeout(()=>marker.openPopup(), 450);
      }
     }
    function render(list){
      listEl.innerHTML = "";
      const rc = document.getElementById('resultCount');
      if(rc){
        rc.textContent = `${list.length}`;
      }
      list.slice(0,300).forEach((p, idx)=>{
        const d = document.createElement('div');
        d.classList.add('park-row');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = p.name;
        d.appendChild(nameSpan);
        // Favorite star
        const star = document.createElement('button');
        star.type='button';
        star.className='fav-star';
        star.setAttribute('aria-label','favorite');
        star.textContent = favorites.has(p._idx)?'‚òÖ':'‚òÜ';
        star.style.marginLeft='8px';
        star.onclick = (e)=>{
          e.stopPropagation();
            if(favorites.has(p._idx)) favorites.delete(p._idx); else favorites.add(p._idx);
            localStorage.setItem('favorites', JSON.stringify([...favorites]));
            star.textContent = favorites.has(p._idx)?'‚òÖ':'‚òÜ';
            if(showFavoritesOnly && !favorites.has(p._idx)){
              d.remove();
            }
        };
        d.appendChild(star);
        if(typeof p.dist === 'number' && userLocation){
          const distSpan = document.createElement('span');
          distSpan.style.fontSize='11px';
          distSpan.style.marginLeft='6px';
            distSpan.style.color='#555';
          distSpan.textContent = `(${formatDistance(p.dist)})`;
          d.appendChild(distSpan);
        }
        if(p.category){
          d.style.borderLeft = `6px solid var(--cat-${cssSafe(p.category)})`;
        }
        d.tabIndex = 0;
        d.setAttribute('role', 'button');
        d.setAttribute('aria-label', p.name);
        d.onclick = ()=> {
          // Remove previous selection
          listEl.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
          d.classList.add('selected');
          // Find marker by lat/lon and open popup
          focusPark(p);
        };
        d.onkeydown = (e) => { if(e.key==="Enter"||e.key===" ") d.onclick(); };
        listEl.appendChild(d);
      });
    }

    // --- Fuzzy & Romaji/Hiragana Search Preparation ---
    function katakanaToHiragana(str){
      return str.replace(/[„Ç°-„É≥]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0x60));
    }
    // Basic romaji -> hiragana conversion (heuristic, not full IME)
    const ROMA_MAP = [
      'kya','kyu','kyo','gya','gyu','gyo','sha','shu','sho','ja','ju','jo','cha','chu','cho','nya','nyu','nyo','hya','hyu','hyo','bya','byu','byo','pya','pyu','pyo','mya','myu','myo','rya','ryu','ryo','tsu','shi','chi','fu'
    ];
    const SIMPLE_ROMA = { a:'„ÅÇ', i:'„ÅÑ', u:'„ÅÜ', e:'„Åà', o:'„Åä', n:'„Çì', wa:'„Çè', we:'„ÅÜ„Åá', wi:'„ÅÜ„ÅÉ', wo:'„Çí' };
    function romajiToHiragana(input){
      let s = input.toLowerCase().replace(/[^a-z]/g,'');
      if(!s) return '';
      // Double consonant => small tsu
      s = s.replace(/([bcdfghjklmnpqrstvwxyz])\1/g,'„Å£$1');
      // Long vowel marker
      let out='';
      while(s){
        let matched=false;
        for(const seq of ROMA_MAP.sort((a,b)=>b.length-a.length)){
          if(s.startsWith(seq)){
            matched=true;
            out+=({
              kya:'„Åç„ÇÉ',kyu:'„Åç„ÇÖ',kyo:'„Åç„Çá',gya:'„Åé„ÇÉ',gyu:'„Åé„ÇÖ',gyo:'„Åé„Çá',sha:'„Åó„ÇÉ',shu:'„Åó„ÇÖ',sho:'„Åó„Çá',ja:'„Åò„ÇÉ',ju:'„Åò„ÇÖ',jo:'„Åò„Çá',
              cha:'„Å°„ÇÉ',chu:'„Å°„ÇÖ',cho:'„Å°„Çá',nya:'„Å´„ÇÉ',nyu:'„Å´„ÇÖ',nyo:'„Å´„Çá',hya:'„Å≤„ÇÉ',hyu:'„Å≤„ÇÖ',hyo:'„Å≤„Çá',bya:'„Å≥„ÇÉ',byu:'„Å≥„ÇÖ',byo:'„Å≥„Çá',
              pya:'„Å¥„ÇÉ',pyu:'„Å¥„ÇÖ',pyo:'„Å¥„Çá',mya:'„Åø„ÇÉ',myu:'„Åø„ÇÖ',myo:'„Åø„Çá',rya:'„Çä„ÇÉ',ryu:'„Çä„ÇÖ',ryo:'„Çä„Çá',tsu:'„Å§',shi:'„Åó',chi:'„Å°',fu:'„Åµ'
            })[seq];
            s=s.slice(seq.length);
            break;
          }
        }
        if(matched) continue;
        // 2-letter syllables
        if(s.length>=2){
          const bi=s.slice(0,2);
          const mapBi={ka:'„Åã',ki:'„Åç',ku:'„Åè',ke:'„Åë',ko:'„Åì',ga:'„Åå',gi:'„Åé',gu:'„Åê',ge:'„Åí',go:'„Åî',sa:'„Åï',si:'„Åó',su:'„Åô',se:'„Åõ',so:'„Åù',
            za:'„Åñ',zi:'„Åò',zu:'„Åö',ze:'„Åú',zo:'„Åû',ta:'„Åü',ti:'„Å°',tu:'„Å§',te:'„Å¶',to:'„Å®',da:'„Å†',di:'„Å¢',du:'„Å•',de:'„Åß',do:'„Å©',na:'„Å™',ni:'„Å´',nu:'„Å¨',ne:'„Å≠',no:'„ÅÆ',
            ha:'„ÅØ',hi:'„Å≤',hu:'„Åµ',he:'„Å∏',ho:'„Åª',ba:'„Å∞',bi:'„Å≥',bu:'„Å∂',be:'„Åπ',bo:'„Åº',pa:'„Å±',pi:'„Å¥',pu:'„Å∑',pe:'„Å∫',po:'„ÅΩ',ma:'„Åæ',mi:'„Åø',mu:'„ÇÄ',me:'„ÇÅ',mo:'„ÇÇ',
            ya:'„ÇÑ',yu:'„ÇÜ',yo:'„Çà',ra:'„Çâ',ri:'„Çä',ru:'„Çã',re:'„Çå',ro:'„Çç',la:'„Çâ',li:'„Çä',lu:'„Çã',le:'„Çå',lo:'„Çç',wa:'„Çè',wi:'„ÅÜ„ÅÉ',we:'„ÅÜ„Åá',wo:'„Çí'};
          if(mapBi[bi]){ out+=mapBi[bi]; s=s.slice(2); continue; }
        }
        // single letter
        const ch = s[0];
        if(SIMPLE_ROMA[ch]) out+=SIMPLE_ROMA[ch];
        s=s.slice(1);
      }
      return out;
    }
    // Precompute search tokens
    publicFacilities.forEach(p=>{
      const name = p.name || '';
      const hira = katakanaToHiragana(name);
      // VERY naive romaji derivation: take existing kana only
      p._nameHira = hira;
      p._searchTokens = `${name} ${hira}`;
    });
    let fuse = null;
    if(window.Fuse){
      fuse = new Fuse(publicFacilities, { keys:['name','_searchTokens'], threshold:0.4, ignoreLocation:true, minMatchCharLength:2 });
    }
    function searchFilter(text, list){
      if(!text) return list;
      const q = text.trim();
      const variants = new Set();
      variants.add(q);
      // If romaji only, convert to hiragana
      if(/^[a-zA-Z]+$/.test(q)){
        const hira = romajiToHiragana(q);
        if(hira) variants.add(hira);
      }
      // If contains katakana, add hiragana version
      if(/[„Ç°-„É≥]/.test(q)) variants.add(katakanaToHiragana(q));
      if(!fuse){
        // Fallback substring match
        return list.filter(p=>{
          return Array.from(variants).some(v=> p.name.includes(v) || (p._nameHira && p._nameHira.includes(v)) );
        });
      }
      const resultIdx = new Set();
      variants.forEach(v=>{
        fuse.search(v).forEach(r=> resultIdx.add(r.item._idx));
      });
      return list.filter(p=> resultIdx.has(p._idx));
    }

    function applyFilters(){
      const text = qEl.value.trim();
      const selected = Array.from(catBox.querySelectorAll('.catChk')).filter(c=>c.checked).map(c=>c.value);
      let filtered = publicFacilities;
      if(selected.length && selected.length !== categories.length){
        const set = new Set(selected);
        filtered = filtered.filter(p=> set.has(p.category));
      }
      if(text) filtered = searchFilter(text, filtered);
      // Distance filtering (only if userLocation known and maxDistance > 0)
      if(maxDistance>0 && userLocation){
        filtered = filtered.filter(p=> typeof p.dist==='number' && p.dist <= maxDistance);
      }
      if(sortMode==='distance' && userLocation){
        filtered = [...filtered].sort((a,b)=>{
          if(typeof a.dist !== 'number') return 1;
          if(typeof b.dist !== 'number') return -1;
          return a.dist - b.dist;
        });
      } else if(sortMode==='name') {
        filtered = [...filtered].sort((a,b)=> a.name.localeCompare(b.name, 'ja'));
      }
      if(showFavoritesOnly){
        filtered = filtered.filter(p=> favorites.has(p._idx));
      }
  render(filtered);
  populateCluster(filtered);
      updateCatCount();
      updateSelectAllButton();
    }
    qEl.oninput = applyFilters;

    // Wait for map and markers to be ready
    function setupEnhancements() {
      // Add bounds & zoom constraints once
      if(!leafletMap.__customBounded){
        const bounds = [[35.4, 139.4],[35.9, 140.1]];
        leafletMap.setMaxBounds(bounds);
        leafletMap.on('drag', () => leafletMap.panInsideBounds(bounds, { animate:false }));
        leafletMap.options.minZoom = 10;
        leafletMap.options.maxZoom = 18;
        leafletMap.__customBounded = true;
      }
    }
    // Marker visibility filtering
    function updateMarkerVisibility(visibleList){
      // No-op: clustering rebuild handles visibility
     }

    // Inject dynamic CSS vars for category colors based on first matching marker icon color class
    function deriveCategoryColors(){
      // Use categoryColors directly to set CSS vars
      let css=':root{';
      Object.entries(categoryColors).forEach(([cat,color])=>{ css+=`--cat-${cssSafe(cat)}:${color};`; });
      css+='}';
      const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
      buildLegend(categoryColors);
    }
    function leafletColorToHex(c){ return c; }
    
  function buildLegend(sample){
      const legend = document.createElement('div');
      legend.setAttribute('data-legend','1');
      legend.style.position='absolute';
      legend.style.bottom='8px';
      legend.style.right='8px';
      legend.style.background='rgba(255,255,255,0.92)';
      legend.style.padding='8px 10px';
      legend.style.fontSize='12px';
      legend.style.border='1px solid #ccc';
      legend.style.borderRadius='6px';
      legend.style.maxHeight='220px';
      legend.style.overflow='auto';
  const legendTitle = tr('legendTitle');
  legend.innerHTML = `<b style="font-size:12px;">${legendTitle}</b><br>` +
        Object.keys(sample).sort().map(cat=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
          <span style="width:12px;height:12px;border-radius:50%;background:var(--cat-${cssSafe(cat)});"></span>
          <span>${cat}</span></div>`).join('');
      document.querySelector('.map-wrap').appendChild(legend);
    }

  function syncMarkerColors(){
    // Align marker icon background with CSS vars (in case palette changes)
    const rootStyles = getComputedStyle(document.documentElement);
    markers.forEach(obj=>{
      if(!obj.cat) return;
      const varName = `--cat-${cssSafe(obj.cat)}`;
      const col = rootStyles.getPropertyValue(varName).trim();
      if(col){
        const el = obj.marker.getElement();
        if(el){
          const div = el.querySelector('.park-icon');
          if(div) div.style.setProperty('--icon-bg', col);
        }
      }
    });
  }
  function initAfterMap(){ setupEnhancements(); deriveCategoryColors(); syncMarkerColors(); applyFilters(); }
  initAfterMap();
  render(publicFacilities);

  // Helpers for dynamic UI bits
  function updateCatCount(){
    const countEl=document.getElementById('catCount');
    if(!countEl) return;
    const total=categories.length;
    const selected=catBox.querySelectorAll('.catChk:checked').length;
    countEl.textContent = `${selected}/${total}`;
  }
  function updateSelectAllButton(){
    const btn = selectAllBtn;
    const boxes = Array.from(catBox.querySelectorAll('.catChk'));
    const selected = boxes.filter(b=>b.checked).length;
    if(selected===0){
      btn.textContent= tr('selectAll_noneSelected');
      btn.classList.remove('partial','clear');
      btn.classList.add('clear');
      btn.setAttribute('aria-pressed','false');
    } else if(selected===boxes.length){
      btn.textContent= tr('selectAll_allSelected');
      btn.classList.remove('partial','clear');
      btn.setAttribute('aria-pressed','true');
    } else {
      btn.textContent= tr('selectAll_partial');
      btn.classList.add('partial');
      btn.classList.remove('clear');
      btn.setAttribute('aria-pressed','mixed');
    }
  }

  // Translation helpers
  function tr(key){
    return (I18N[currentLang] && I18N[currentLang][key]) || key;
  }
  function applyTranslations(){
    document.documentElement.lang = currentLang;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      const txt = tr(k);
      if(txt) el.textContent = txt;
    });
    // Reset distance value label when unlimited (after translation swap)
    if(maxDistance===0){
      const dv=document.getElementById('distValue');
      if(dv) dv.textContent = tr('distanceAll');
    }
    // Update favorites toggle label
    const favSpan = document.querySelector('#favToggle span[data-i18n]');
    if(favSpan){ favSpan.textContent = tr(showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); }
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const k = el.getAttribute('data-i18n-placeholder');
      const txt = tr(k);
      if(txt) el.setAttribute('placeholder', txt);
    });
    updateSelectAllButton();
    // Maintain location button state
    const locBtn = document.getElementById('locBtn');
    if(locBtn && userLocation){
      locBtn.classList.add('active-loc');
      const span = locBtn.querySelector('[data-i18n]');
      if(span){ span.setAttribute('data-i18n','locationSetLabel'); span.textContent = tr('locationSetLabel'); }
    }
  }
  function setupLangButtons(){
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.lang===currentLang);
      btn.setAttribute('aria-pressed', btn.dataset.lang===currentLang ? 'true':'false');
      btn.onclick = ()=>{
        currentLang = btn.dataset.lang;
        localStorage.setItem('lang', currentLang);
        document.querySelectorAll('.lang-btn').forEach(b=>{
          b.classList.toggle('active', b===btn);
          b.setAttribute('aria-pressed', b===btn ? 'true':'false');
        });
        // Rebuild legend for translated title
        document.querySelectorAll('.map-wrap > div[data-legend="1"]').forEach(div=> div.remove());
        buildLegend(categoryColors);
        applyTranslations();
        // Rebuild popups with translated labels
        rebuildAllPopups();
      };
    });
  }
  // Style for language buttons injected dynamically
  (function(){
    const style=document.createElement('style');
    style.textContent = `.lang-btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;backdrop-filter:blur(4px);} .lang-btn.active{background:#fff;color:#1b6dcf;border-color:#fff;} .lang-btn:hover{background:#ffffff55;}`;
    document.head.appendChild(style);
  })();
  // Location button active style
  (function(){
    const style=document.createElement('style');
    style.textContent = `#locBtn.active-loc{background:#1b6dcf !important; color:#fff !important; border-color:#1b6dcf !important;}`;
    document.head.appendChild(style);
  })();
  // Initial translation setup
  applyTranslations();
  setupLangButtons();

  // --- Location / Distance Features ---
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371000; // m
    const toRad = d=>d*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // meters
  }
  function updateDistances(){
    if(!userLocation) return;
  publicFacilities.forEach(p=>{
      p.dist = haversine(userLocation.lat, userLocation.lon, p.lat, p.lon);
    });
  }
  function formatDistance(m){
    const unitM = tr('distanceUnitMeters');
    const unitKm = tr('distanceUnitKilometers');
    if(m < 1000) return `${Math.round(m)} ${unitM}`;
    const km = m/1000;
    if(km < 10) return `${km.toFixed(2)} ${unitKm}`;
    return `${km.toFixed(1)} ${unitKm}`;
  }
  function requestLocation(force){
    if(userLocation && !force){
      updateDistances();
      applyFilters();
      // Already have location: ensure button reflects state
      const locBtn = document.getElementById('locBtn');
      if(locBtn){
        locBtn.classList.add('active-loc');
        const span = locBtn.querySelector('[data-i18n="useLocationLabel"], [data-i18n="locationSetLabel"]');
        if(span){ span.setAttribute('data-i18n','locationSetLabel'); span.textContent = tr('locationSetLabel'); }
      }
  const statusEl = document.getElementById('locStatus');
  if(statusEl) statusEl.textContent='';
      return;
    }
    const statusEl = document.getElementById('locStatus');
    statusEl.textContent = currentLang==='ja'? '‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠...' : 'Getting location...';
    if(!navigator.geolocation){
      statusEl.textContent = currentLang==='ja'? 'Êú™ÂØæÂøú„Éñ„É©„Ç¶„Ç∂' : 'Geolocation unsupported';
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude, accuracy} = pos.coords;
      userLocation = {lat: latitude, lon: longitude, accuracy};
  // Clear status (no persistent success text needed; button color indicates state)
  statusEl.textContent = '';
      showUserLocation();
      updateDistances();
      applyFilters();
      updatePopupsWithDirections();
      // Update button to indicate set
      const locBtn = document.getElementById('locBtn');
      if(locBtn){
        locBtn.classList.add('active-loc');
        const span = locBtn.querySelector('[data-i18n]');
        if(span){ span.setAttribute('data-i18n','locationSetLabel'); span.textContent = tr('locationSetLabel'); }
      }
    }, err=>{
      statusEl.textContent = (currentLang==='ja'? 'Â§±Êïó: ' : 'Error: ')+ err.message;
    }, {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
  }
  function showUserLocation(){
    if(!userLocation) return;
    if(locationMarker){
      locationMarker.setLatLng([userLocation.lat, userLocation.lon]);
      if(locationAccuracyCircle) locationAccuracyCircle.setLatLng([userLocation.lat, userLocation.lon]);
    } else {
      locationMarker = L.marker([userLocation.lat, userLocation.lon], {title:'You'}).addTo(leafletMap);
      locationAccuracyCircle = L.circle([userLocation.lat, userLocation.lon], {radius: userLocation.accuracy||30, color:'#136aec', fillColor:'#136aec', fillOpacity:0.15, weight:1}).addTo(leafletMap);
    }
  }
  function rebuildAllPopups(){
    markers.forEach(({marker, parkIdx})=>{
  const p = publicFacilities.find(pp=>pp._idx===parkIdx);
      if(!p) return;
      let popup = `<b>${p.name}</b><br>${p.address||''}`;
      if(p.category) popup += `<br><span style=\"display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;\">${p.category}</span>`;
      if(p.url) popup += `<br><a href='${p.url}' target='_blank'>${tr('linkLabel')}</a>`;
      if(userLocation && typeof p.dist==='number') popup += `<br><small>${formatDistance(p.dist)}</small>`;
      if(userLocation){
        const gmaps = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lon}/${p.lat},${p.lon}`;
        popup += `<br><a href='${gmaps}' target='_blank'>${tr('directionsLabel')}</a>`;
      }
      marker.bindPopup(popup);
    });
  }
  function updatePopupsWithDirections(){
    if(!userLocation) return;
    rebuildAllPopups();
  }
  document.getElementById('locBtn').addEventListener('click', ()=>{ requestLocation(); });
  document.getElementById('sortNameBtn').addEventListener('click', ()=>{ sortMode='name'; toggleSortButtons(); applyFilters(); });
  document.getElementById('sortDistBtn').addEventListener('click', ()=>{ sortMode='distance'; if(!userLocation) requestLocation(); else { updateDistances(); } toggleSortButtons(); applyFilters(); });
  // Distance range events
  const distRange = document.getElementById('distRange');
  const distValue = document.getElementById('distValue');
  if(distRange){
    distRange.addEventListener('input', ()=>{
      const v = parseInt(distRange.value,10);
      maxDistance = v;
      if(v===0){
        distValue.textContent = tr('distanceAll');
      } else if(v < 1000){
        distValue.textContent = v + ' ' + tr('distanceUnitMeters');
      } else {
        distValue.textContent = (v/1000).toFixed(v%1000===0?0:1) + ' ' + tr('distanceUnitKilometers');
      }
      if(!userLocation && v>0){ requestLocation(); } else { applyFilters(); }
    });
  }
  // Quick distance chips
  document.querySelectorAll('.qd-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const dist = parseInt(btn.dataset.dist,10);
      maxDistance = dist;
      if(distRange) distRange.value = dist;
      if(dist===0){ distValue.textContent = tr('distanceAll'); }
      else if(dist<1000){ distValue.textContent = dist + ' ' + tr('distanceUnitMeters'); }
      else distValue.textContent = (dist/1000).toFixed(dist%1000===0?0:1) + ' ' + tr('distanceUnitKilometers');
      if(dist>0 && !userLocation) requestLocation(); else applyFilters();
      document.querySelectorAll('.qd-btn').forEach(b=> b.classList.toggle('active', b===btn));
    });
  });
  // Favorites toggle
  const favToggle = document.getElementById('favToggle');
  favToggle.addEventListener('click', ()=>{
    showFavoritesOnly = !showFavoritesOnly;
    favToggle.dataset.mode = showFavoritesOnly? 'fav':'all';
    const span = favToggle.querySelector('span[data-i18n]');
    if(span){ span.setAttribute('data-i18n', showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); span.textContent = tr(showFavoritesOnly? 'favoritesShowAll':'favoritesShowOnly'); }
    applyFilters();
  });
  // Optional: try auto locate after short delay (can be removed if undesired)
  setTimeout(()=>{ /* requestLocation(); */ }, 2500);

  // Enhance styles for active sort
  (function(){
    const style=document.createElement('style');
    style.textContent += `.tiny-btn.active{background:#1cb5e0 !important; color:#fff !important; border-color:#1699bd !important;}`;
    style.textContent += `.qd-btn.active{background:#1cb5e0;color:#fff;border-color:#1699bd;}`;
    style.textContent += `.fav-star{background:transparent;border:none;cursor:pointer;font-size:14px;line-height:1;padding:0 2px;color:#e0b800;} .fav-star:hover{transform:scale(1.15);} .fav-star:focus{outline:2px solid #1cb5e0;outline-offset:2px;}`;
    document.head.appendChild(style);
  })();

  </script>
</body>
</html>
