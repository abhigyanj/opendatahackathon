<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Tokyo Parks Map | 都立公園マップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f6f8fa;
      color: #222;
    }
    header {
      background: linear-gradient(90deg, #4f8ef7 0%, #1cb5e0 100%);
      color: #fff;
      padding: 32px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px #0001;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.95;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 0 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
    }
    #panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 20px 20px 20px;
      max-width: 340px;
      min-width: 260px;
      flex: 1 1 320px;
      font-size: 15px;
      margin-bottom: 32px;
      height: fit-content;
    }
    #panel strong {
      font-size: 1.2rem;
      color: #4f8ef7;
      letter-spacing: 1px;
    }
    #panel input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    #panel input:focus {
      border: 1.5px solid #4f8ef7;
    }
    #list {
      max-height: 50vh;
      overflow: auto;
      margin-top: 12px;
    }
    #list div {
      cursor: pointer;
      padding: 7px 0 7px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, color 0.15s;
      border-left: 4px solid transparent;
    }
    #list div:hover {
      background: #e3f0ff;
    }
    #list div.selected {
      background: #d0e7ff;
      color: #1976d2;
      border-left: 4px solid #4f8ef7;
      font-weight: 700;
    }
    .about {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 24px 20px 24px;
      margin-bottom: 32px;
      flex: 2 1 400px;
      min-width: 320px;
      max-width: 700px;
    }
    .about h2 {
      margin-top: 0;
      color: #1cb5e0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .about p {
      font-size: 1.08rem;
      line-height: 1.7;
      margin-bottom: 0.7em;
    }
    .about ul {
      margin: 0 0 0 1.2em;
      padding: 0;
      font-size: 1rem;
    }
    .about li {
      margin-bottom: 0.4em;
    }
    .map-wrap {
      width: 100%;
      height: 520px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 16px #0002;
      background: #fff;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      max-height: 520px;
    }
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 0;
      }
      .about, #panel {
        max-width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tokyo Parks Map <span style="font-size:1.2rem;">| 都立公園マップ</span></h1>
    <p>Discover, search, and explore Tokyo's public parks on an interactive map.</p>
  </header>
  <div class="container">
    <div id="panel">
      <strong>公園を検索</strong><br>
      <input id="q" placeholder="公園名で検索...">
      <div style="margin-top:12px; font-size:0.9rem; color:#555;">カテゴリー</div>
      <select id="catFilter" style="width:100%;margin-top:4px;padding:6px 8px;border:1px solid #cfd8dc;border-radius:6px;font-size:0.95rem;">
        <option value="">(すべて)</option>
      </select>
      <div id="list"></div>
    </div>
    <div class="about">
      <h2>About This Website</h2>
      <p>
        <b>Tokyo Parks Map</b> is an open-data web application that helps you discover and explore public parks across Tokyo. The interactive map allows you to search for parks by name, view their locations, and access details such as addresses and descriptions. This project is built for the Open Data Hackathon to promote the use of public data for the benefit of residents and visitors.
      </p>
      <ul>
        <li>Search for parks by name in Japanese</li>
        <li>Click on a park to zoom to its location on the map</li>
        <li>View park details, addresses, and links (where available)</li>
        <li>Data sourced from Tokyo's open government datasets</li>
        <li>Built with Python, Flask, and Folium/Leaflet.js</li>
      </ul>
      <p style="margin-top:1.2em; color:#888; font-size:0.98em;">&copy; 2025 Tokyo Parks Map | Open Data Hackathon</p>
    </div>
  </div>
  <div class="map-wrap">
    <div id="map">{{ map_html|safe }}</div>
  </div>
  <script>
    const parks = {{ parks_json|safe }};
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const catEl = document.getElementById('catFilter');

    // Build category options
    const categories = [...new Set(parks.map(p=>p.category).filter(Boolean))].sort();
    categories.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; catEl.appendChild(opt); });

    // Robust map + marker handling
    let leafletMap = null;
    function detectMap(){
      if(leafletMap) return leafletMap;
      // Use injected reference first
      if(window.leafletMapObj) {
        leafletMap = window.leafletMapObj;
        return leafletMap;
      }
      // Direct folium pattern: div.folium-map id="map_xxxxx"
      const mapDiv = document.querySelector('.folium-map');
      if(mapDiv){
        const id = mapDiv.id; // e.g. map_123abc
        if(id && window[id]) leafletMap = window[id];
      }
      // Fallback: scan window keys starting with map_
      if(!leafletMap){
        for (const k in window){
          if(k.startsWith('map_')){
            const v = window[k];
            if(v && typeof v.setView === 'function' && v._layers){
              leafletMap = v; break;
            }
          }
        }
      }
      return leafletMap;
    }

    function focusPark(p){
      const mapObj = detectMap();
      if(!mapObj) return;
      mapObj.flyTo([p.lat, p.lon], 15, {animate:true, duration:0.75});
      setTimeout(()=>{
        // Try to find existing marker
        let found=null;
        for(const id in mapObj._layers){
          const layer = mapObj._layers[id];
            if(layer && layer.getLatLng){
              const ll = layer.getLatLng();
              if(Math.abs(ll.lat - p.lat) < 1e-6 && Math.abs(ll.lng - p.lon) < 1e-6){
                found = layer; break;
              }
            }
        }
        if(found && found.openPopup){
          found.openPopup();
        } else if(window.L){
          window.L.popup({maxWidth:260}).setLatLng([p.lat,p.lon]).setContent(`<b>${p.name}</b><br>${p.address||''}`).openOn(mapObj);
        }
      }, 400);
    }
    function render(list){
      listEl.innerHTML = "";
      list.slice(0,300).forEach((p, idx)=>{
        const d = document.createElement('div');
        d.textContent = p.name;
        if(p.category){
          d.style.borderLeft = `6px solid var(--cat-${cssSafe(p.category)})`;
        }
        d.tabIndex = 0;
        d.setAttribute('role', 'button');
        d.setAttribute('aria-label', p.name);
        d.onclick = ()=> {
          // Remove previous selection
          listEl.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
          d.classList.add('selected');
          // Find marker by lat/lon and open popup
          focusPark(p);
        };
        d.onkeydown = (e) => { if(e.key==="Enter"||e.key===" ") d.onclick(); };
        listEl.appendChild(d);
      });
    }

    function applyFilters(){
      const text = qEl.value.trim();
      const cat = catEl.value;
      let filtered = parks;
      if(cat) filtered = filtered.filter(p=>p.category===cat);
      if(text) filtered = filtered.filter(p=>p.name.includes(text));
      render(filtered);
      updateMarkerVisibility(filtered);
    }
    qEl.oninput = applyFilters;
    catEl.onchange = applyFilters;

    // Wait for map and markers to be ready
    function setupEnhancements() {
      const mapObj = detectMap();
      if(!mapObj) return;
      // Add bounds & zoom constraints once
      if(!mapObj.__customBounded){
        const bounds = [[35.4, 139.4],[35.9, 140.1]];
        mapObj.setMaxBounds(bounds);
        mapObj.on('drag', () => mapObj.panInsideBounds(bounds, { animate:false }));
        mapObj.options.minZoom = 10;
        mapObj.options.maxZoom = 18;
        mapObj.__customBounded = true;
      }
    }
    // Folium/Leaflet loads map async, so wait for it
    function waitForMap(cb, tries=0) {
      const mapObj = detectMap();
      if(mapObj && mapObj._layers && Object.keys(mapObj._layers).length>0) { cb(); return; }
      if(tries>120) { console.warn('Map not detected'); return; }
      setTimeout(()=>waitForMap(cb, tries+1), 100);
    }
    // Marker visibility filtering
    function updateMarkerVisibility(visibleList){
      const mapObj = detectMap();
      if(!mapObj) return;
      const allowed = new Set(visibleList.map(p=>`${p.lat.toFixed(6)},${p.lon.toFixed(6)}`));
      for(const id in mapObj._layers){
        const layer = mapObj._layers[id];
        if(layer && layer.getLatLng && layer._icon){
          const ll = layer.getLatLng();
          const key = `${ll.lat.toFixed(6)},${ll.lng.toFixed(6)}`;
          if(allowed.has(key)){
            layer._icon.style.display = '';
            if(layer._shadow) layer._shadow.style.display='';
          } else {
            layer._icon.style.display = 'none';
            if(layer._shadow) layer._shadow.style.display='none';
          }
        }
      }
    }

    // Inject dynamic CSS vars for category colors based on first matching marker icon color class
    function deriveCategoryColors(){
      const mapObj = detectMap();
      if(!mapObj) return;
      const sample = {};
      for(const id in mapObj._layers){
        const layer = mapObj._layers[id];
        if(layer && layer.options && layer.options.icon && layer.options.icon.options && layer.options.icon.options.markerColor){
          const ll = layer.getLatLng();
          const park = parks.find(p=>Math.abs(p.lat-ll.lat)<1e-6 && Math.abs(p.lon-ll.lng)<1e-6);
          if(park && !sample[park.category]){
            sample[park.category] = layer.options.icon.options.markerColor;
          }
        }
      }
      let css = ':root{' ;
      Object.entries(sample).forEach(([cat,color])=>{ css += `--cat-${cssSafe(cat)}:${leafletColorToHex(color)};`; });
      css += '}';
      const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);
      buildLegend(sample);
    }
    function cssSafe(s){return s.replace(/[^a-zA-Z0-9_-]/g,'_');}
    function leafletColorToHex(c){
      const map={red:'#d63e2a',blue:'#2a81cb',green:'#2aad27',purple:'#6f42c1',orange:'#f69730',darkred:'#772015',cadetblue:'#3c8dbc',darkgreen:'#115f0a',darkpurple:'#301934',pink:'#ff4da3',lightblue:'#87ceeb',lightgreen:'#90ee90',gray:'#808080',black:'#000000',lightgray:'#d3d3d3',beige:'#f5f5dc',lightred:'#ff7f7f',darkblue:'#0a3172',white:'#ffffff'}; return map[c]||c; }
    function buildLegend(sample){
      const legend = document.createElement('div');
      legend.style.position='absolute';
      legend.style.bottom='8px';
      legend.style.right='8px';
      legend.style.background='rgba(255,255,255,0.92)';
      legend.style.padding='8px 10px';
      legend.style.fontSize='12px';
      legend.style.border='1px solid #ccc';
      legend.style.borderRadius='6px';
      legend.style.maxHeight='180px';
      legend.style.overflow='auto';
      legend.innerHTML = '<b style="font-size:12px;">カテゴリー</b><br>' +
        Object.keys(sample).sort().map(cat=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
          <span style="width:12px;height:12px;border-radius:50%;background:var(--cat-${cssSafe(cat)});"></span>
          <span>${cat}</span></div>`).join('');
      document.querySelector('.map-wrap').appendChild(legend);
    }

    function initAfterMap(){ deriveCategoryColors(); applyFilters(); }
    waitForMap(()=>{ setupEnhancements(); initAfterMap(); });
    // Initial list before map if needed
    render(parks);
    
  </script>
</body>
</html>
