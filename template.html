<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title data-i18n="pageTitle">Tokyo Parks Map | 都立公園マップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f6f8fa;
      color: #222;
    }
    header {
      background: linear-gradient(90deg, #4f8ef7 0%, #1cb5e0 100%);
      color: #fff;
      padding: 32px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px #0001;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.95;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 0 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
    }
    #panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 20px 20px 20px;
      max-width: 340px;
      min-width: 260px;
      flex: 1 1 320px;
      font-size: 15px;
      margin-bottom: 32px;
      height: fit-content;
    }
    #panel strong {
      font-size: 1.2rem;
      color: #4f8ef7;
      letter-spacing: 1px;
    }
  #panel .section-label { display:flex; align-items:center; justify-content:space-between; margin-top:14px; }
  #panel .section-label h3 { margin:0; font-size:0.95rem; letter-spacing:.5px; color:#333; font-weight:600; }
  #panel small.muted { color:#667; font-size:.7rem; font-weight:500; }
  #panel button.tiny-btn { background:#eef3f8; border:1px solid #c5d3de; border-radius:6px; font-size:11px; padding:4px 10px; cursor:pointer; line-height:1; letter-spacing:.5px; display:inline-flex; align-items:center; gap:4px; }
  #panel button.tiny-btn:hover { background:#e2edf6; }
  #panel button.tiny-btn.partial { background:#fff4d3; border-color:#f0c662; }
  #panel button.tiny-btn.clear { background:#ffe3e3; border-color:#ffb2b2; }
  #panel button.tiny-btn.clear:hover { background:#ffd4d4; }
  /* Category list items */
  .cat-item { display:flex; align-items:flex-start; gap:6px; cursor:pointer; position:relative; font-size:12.5px; line-height:1.25; padding:4px 2px 4px 0; }
  .cat-item input.catChk { position:absolute; opacity:0; inset:0; cursor:pointer; }
  .cat-item .fake-box { width:18px; height:18px; border:2px solid #4f8ef7; border-radius:5px; display:flex; align-items:center; justify-content:center; background:#4f8ef7; flex:0 0 18px; box-sizing:border-box; position:relative; }
  .cat-item .fake-box .tick { font-size:13px; line-height:1; font-weight:700; color:#fff; transition:opacity .15s; }
  .cat-item.unchecked .fake-box { background:#fff; border-color:#9bb7cc; }
  .cat-item.unchecked .fake-box .tick { opacity:0; }
  .cat-item:focus-within { outline:2px solid #1cb5e0; outline-offset:2px; }
  .cat-item .color-dot { width:13px; height:13px; border-radius:50%; border:1px solid #3333; flex:0 0 13px; margin-top:2px; }
  .cat-item .cat-label { white-space:normal; word-break:keep-all; overflow-wrap:anywhere; flex:1; min-width:0; }
    #panel input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    #panel input:focus {
      border: 1.5px solid #4f8ef7;
    }
    #list {
      max-height: 50vh;
      overflow: auto;
      margin-top: 12px;
    }
    #list div {
      cursor: pointer;
      padding: 7px 0 7px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, color 0.15s;
      border-left: 4px solid transparent;
    }
    #list div:hover {
      background: #e3f0ff;
    }
    #list div.selected {
      background: #d0e7ff;
      color: #1976d2;
      border-left: 4px solid #4f8ef7;
      font-weight: 700;
    }
    .about {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      padding: 24px 24px 20px 24px;
      margin-bottom: 32px;
      flex: 2 1 400px;
      min-width: 320px;
      max-width: 700px;
    }
    .about h2 {
      margin-top: 0;
      color: #1cb5e0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .about p {
      font-size: 1.08rem;
      line-height: 1.7;
      margin-bottom: 0.7em;
    }
    .about ul {
      margin: 0 0 0 1.2em;
      padding: 0;
      font-size: 1rem;
    }
    .about li {
      margin-bottom: 0.4em;
    }
    .map-wrap {
      width: 100%;
      height: 520px;
      max-width: 1200px;
      margin: 0 auto 32px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 16px #0002;
      background: #fff;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      max-height: 520px;
    }
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 0;
      }
      .about, #panel {
        max-width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap;">
      <h1 data-i18n="headerTitle">Tokyo Parks Map | 都立公園マップ</h1>
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="lang-ja" class="lang-btn" data-lang="ja" aria-pressed="true">日本語</button>
        <button id="lang-en" class="lang-btn" data-lang="en" aria-pressed="false">EN</button>
      </div>
    </div>
    <p data-i18n="subtitle">Discover, search, and explore Tokyo's public parks on an interactive map.</p>
  </header>
  <div class="container">
    <div id="panel">
      <strong data-i18n="searchHeading">公園を検索</strong><br>
      <input id="q" placeholder="公園名で検索..." data-i18n-placeholder="searchPlaceholder">
      <div class="section-label">
        <h3><span data-i18n="categoriesLabel">カテゴリー</span> <small id="catCount" class="muted"></small></h3>
        <button id="catSelectAll" class="tiny-btn" type="button" aria-pressed="true" data-i18n-dynamic="selectAll">全解除</button>
      </div>
  <div id="catBox" style="margin-top:6px; max-height:190px; overflow:auto; border:1px solid #dde5ea; border-radius:8px; padding:8px 10px 6px 10px; background:#fbfdfe; font-size:12.5px; line-height:1.35; display:grid; grid-template-columns: repeat(auto-fill,minmax(170px,1fr)); gap:4px 14px; scrollbar-width:thin;">
      </div>
      <div id="list"></div>
    </div>
    <div class="about">
      <h2 data-i18n="aboutHeading">About This Website</h2>
      <p data-i18n="aboutParagraph1">
        Tokyo Parks Map is an open-data web application that helps you discover and explore public parks across Tokyo.
      </p>
      <ul>
        <li data-i18n="bullet1">Search for parks by name in Japanese</li>
        <li data-i18n="bullet2">Click on a park to zoom to its location on the map</li>
        <li data-i18n="bullet3">View park details, addresses, and links (where available)</li>
        <li data-i18n="bullet4">Data sourced from Tokyo's open government datasets</li>
        <li data-i18n="bullet5">Built with Python, Flask, and Folium/Leaflet.js</li>
      </ul>
      <p style="margin-top:1.2em; color:#888; font-size:0.98em;" data-i18n="footer">© 2025 Tokyo Parks Map | Open Data Hackathon</p>
    </div>
  </div>
  <div class="map-wrap">
    <div id="map"></div>
  </div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Bootstrapped data placeholder; replaced server-side.
  const {parks, centerLat, centerLon, categoryColors} = JSON.parse(decodeURIComponent('BOOTSTRAP_JSON_PLACEHOLDER'));
  const I18N = JSON.parse(decodeURIComponent('I18N_JSON_PLACEHOLDER'));
  let currentLang = (localStorage.getItem('lang')||'ja');
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const catBox = document.getElementById('catBox');
    const selectAllBtn = document.getElementById('catSelectAll');
    const categories = [...new Set(parks.map(p=>p.category).filter(Boolean))].sort();
    
    function cssSafe(s){return s.replace(/[^a-zA-Z0-9_-]/g,'_');}
    
    function buildCategoryFilters(){
      catBox.innerHTML = categories.map(cat=>{
        const safe = cat.replace(/"/g,'&quot;');
        return `<label class="cat-item" data-cat="${safe}">
          <input type="checkbox" class="catChk" value="${safe}" checked aria-label="${safe}">
          <span class="fake-box"><span class="tick">✓</span></span>
          <span class="color-dot" style="background:var(--cat-${cssSafe(cat)},#666);"></span>
          <span class="cat-label">${cat}</span>
        </label>`;
      }).join('');
      catBox.querySelectorAll('.catChk').forEach(cb=>{
        const label = cb.closest('.cat-item');
        if(!cb.checked) label.classList.add('unchecked');
        cb.addEventListener('change', ()=>{
          const lbl = cb.closest('.cat-item');
          if(cb.checked) lbl.classList.remove('unchecked'); else lbl.classList.add('unchecked');
          applyFilters();
        });
      });
      updateCatCount();
      updateSelectAllButton();
    }
    
    buildCategoryFilters();
    
    selectAllBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const boxes = Array.from(catBox.querySelectorAll('.catChk'));
      const allChecked = boxes.every(c=>c.checked);
      const targetState = !allChecked;
      boxes.forEach(c=>{ c.checked = targetState; const label=c.closest('.cat-item'); if(targetState) label.classList.remove('unchecked'); else label.classList.add('unchecked'); });
      applyFilters();
      updateSelectAllButton();
    });

    // Assign stable indices to handle duplicate coordinates distinctly
    parks.forEach((p,i)=>p._idx=i);
    const leafletMap = L.map('map', {zoomControl:true}).setView([centerLat, centerLon], 10);
    const baseLayers = {
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(leafletMap),
      'OSM HOT': L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors, HOT'
      }),
      'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '© OpenStreetMap contributors, SRTM | OpenTopoMap (CC-BY-SA)'
      }),
      'Carto Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '© OpenStreetMap © CARTO'
      }),
      'Carto Dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '© OpenStreetMap © CARTO'
      }),
      'Esri Imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles © Esri & contributors'
      }),
      'Esri Topo': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'Tiles © Esri & contributors'
      })
    };
    L.control.layers(baseLayers, null, {position:'topright'}).addTo(leafletMap);
    const markerGroup = L.layerGroup().addTo(leafletMap);
  const markers = []; // {marker, parkIdx, cat}
    function addMarkers(){
      parks.forEach(p=>{
        const color = (categoryColors && categoryColors[p.category]) ? categoryColors[p.category] : '#2a81cb';
        const m = L.circleMarker([p.lat, p.lon], {radius:6,color:'#222',weight:1,fillColor:color,fillOpacity:0.85}).addTo(markerGroup);
        let popup = `<b>${p.name}</b><br>${p.address||''}`;
        if(p.category) popup += `<br><span style=\"display:inline-block;padding:2px 6px;background:#eee;border-radius:4px;font-size:11px;margin-top:4px;\">${p.category}</span>`;
        if(p.url) popup += `<br><a href='${p.url}' target='_blank'>Link</a>`;
        if(p.desc) popup += `<br><small>${p.desc.slice(0,180)}...</small>`;
        m.bindPopup(popup);
  markers.push({marker:m, parkIdx:p._idx, cat:p.category});
      });
    }
    addMarkers();

    function focusPark(p){
  leafletMap.flyTo([p.lat, p.lon], 15, {animate:true, duration:0.75});
  const entry = markers.find(e=>e.parkIdx===p._idx);
  if(entry) setTimeout(()=>entry.marker.openPopup(), 450);
    }
    function render(list){
      listEl.innerHTML = "";
      list.slice(0,300).forEach((p, idx)=>{
        const d = document.createElement('div');
        d.textContent = p.name;
        if(p.category){
          d.style.borderLeft = `6px solid var(--cat-${cssSafe(p.category)})`;
        }
        d.tabIndex = 0;
        d.setAttribute('role', 'button');
        d.setAttribute('aria-label', p.name);
        d.onclick = ()=> {
          // Remove previous selection
          listEl.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
          d.classList.add('selected');
          // Find marker by lat/lon and open popup
          focusPark(p);
        };
        d.onkeydown = (e) => { if(e.key==="Enter"||e.key===" ") d.onclick(); };
        listEl.appendChild(d);
      });
    }

    function applyFilters(){
      const text = qEl.value.trim();
      const selected = Array.from(catBox.querySelectorAll('.catChk')).filter(c=>c.checked).map(c=>c.value);
      let filtered = parks;
      if(selected.length && selected.length !== categories.length){
        const set = new Set(selected);
        filtered = filtered.filter(p=> set.has(p.category));
      }
      if(text) filtered = filtered.filter(p=> p.name.includes(text));
      render(filtered);
      updateMarkerVisibility(filtered);
  updateCatCount();
  updateSelectAllButton();
    }
    qEl.oninput = applyFilters;

    // Wait for map and markers to be ready
    function setupEnhancements() {
      // Add bounds & zoom constraints once
      if(!leafletMap.__customBounded){
        const bounds = [[35.4, 139.4],[35.9, 140.1]];
        leafletMap.setMaxBounds(bounds);
        leafletMap.on('drag', () => leafletMap.panInsideBounds(bounds, { animate:false }));
        leafletMap.options.minZoom = 10;
        leafletMap.options.maxZoom = 18;
        leafletMap.__customBounded = true;
      }
    }
    // Marker visibility filtering
    function updateMarkerVisibility(visibleList){
      const allowed = new Set(visibleList.map(p=>p._idx));
      markers.forEach(({marker, parkIdx})=>{
        const el = marker.getElement();
        if(!el) return;
        el.style.display = allowed.has(parkIdx)?'':'none';
      });
    }

    // Inject dynamic CSS vars for category colors based on first matching marker icon color class
    function deriveCategoryColors(){
      // Use categoryColors directly to set CSS vars
      let css=':root{';
      Object.entries(categoryColors).forEach(([cat,color])=>{ css+=`--cat-${cssSafe(cat)}:${color};`; });
      css+='}';
      const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
      buildLegend(categoryColors);
    }
    function leafletColorToHex(c){ return c; }
    
  function buildLegend(sample){
      const legend = document.createElement('div');
      legend.style.position='absolute';
      legend.style.bottom='8px';
      legend.style.right='8px';
      legend.style.background='rgba(255,255,255,0.92)';
      legend.style.padding='8px 10px';
      legend.style.fontSize='12px';
      legend.style.border='1px solid #ccc';
      legend.style.borderRadius='6px';
      legend.style.maxHeight='220px';
      legend.style.overflow='auto';
  const legendTitle = tr('legendTitle');
  legend.innerHTML = `<b style="font-size:12px;">${legendTitle}</b><br>` +
        Object.keys(sample).sort().map(cat=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
          <span style="width:12px;height:12px;border-radius:50%;background:var(--cat-${cssSafe(cat)});"></span>
          <span>${cat}</span></div>`).join('');
      document.querySelector('.map-wrap').appendChild(legend);
    }

  function syncMarkerColors(){
    // Align marker fillColor with CSS vars (in case palette changes)
    const rootStyles = getComputedStyle(document.documentElement);
    markers.forEach(obj=>{
      if(!obj.cat) return;
      const varName = `--cat-${cssSafe(obj.cat)}`;
      const col = rootStyles.getPropertyValue(varName).trim();
      if(col) obj.marker.setStyle({fillColor: col});
    });
  }
  function initAfterMap(){ setupEnhancements(); deriveCategoryColors(); syncMarkerColors(); applyFilters(); }
  initAfterMap();
  render(parks);

  // Helpers for dynamic UI bits
  function updateCatCount(){
    const countEl=document.getElementById('catCount');
    if(!countEl) return;
    const total=categories.length;
    const selected=catBox.querySelectorAll('.catChk:checked').length;
    countEl.textContent = `${selected}/${total}`;
  }
  function updateSelectAllButton(){
    const btn = selectAllBtn;
    const boxes = Array.from(catBox.querySelectorAll('.catChk'));
    const selected = boxes.filter(b=>b.checked).length;
    if(selected===0){
      btn.textContent= tr('selectAll_noneSelected');
      btn.classList.remove('partial','clear');
      btn.classList.add('clear');
      btn.setAttribute('aria-pressed','false');
    } else if(selected===boxes.length){
      btn.textContent= tr('selectAll_allSelected');
      btn.classList.remove('partial','clear');
      btn.setAttribute('aria-pressed','true');
    } else {
      btn.textContent= tr('selectAll_partial');
      btn.classList.add('partial');
      btn.classList.remove('clear');
      btn.setAttribute('aria-pressed','mixed');
    }
  }

  // Translation helpers
  function tr(key){
    return (I18N[currentLang] && I18N[currentLang][key]) || key;
  }
  function applyTranslations(){
    document.documentElement.lang = currentLang;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      const txt = tr(k);
      if(txt) el.textContent = txt;
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const k = el.getAttribute('data-i18n-placeholder');
      const txt = tr(k);
      if(txt) el.setAttribute('placeholder', txt);
    });
    // dynamic select-all is recalculated by updateSelectAllButton()
    updateSelectAllButton();
  }
  function setupLangButtons(){
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.lang===currentLang);
      btn.setAttribute('aria-pressed', btn.dataset.lang===currentLang ? 'true':'false');
      btn.onclick = ()=>{
        currentLang = btn.dataset.lang;
        localStorage.setItem('lang', currentLang);
        document.querySelectorAll('.lang-btn').forEach(b=>{
          b.classList.toggle('active', b===btn);
          b.setAttribute('aria-pressed', b===btn ? 'true':'false');
        });
        // Rebuild legend for translated title
        document.querySelectorAll('.map-wrap > div').forEach(div=>{ if(div.innerHTML && div.innerHTML.includes('var(--cat-')){ div.remove(); }});
        buildLegend(categoryColors);
        applyTranslations();
      };
    });
  }
  // Style for language buttons injected dynamically
  (function(){
    const style=document.createElement('style');
    style.textContent = `.lang-btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;backdrop-filter:blur(4px);} .lang-btn.active{background:#fff;color:#1b6dcf;border-color:#fff;} .lang-btn:hover{background:#ffffff55;}`;
    document.head.appendChild(style);
  })();
  // Initial translation setup
  applyTranslations();
  setupLangButtons();

  </script>
</body>
</html>
